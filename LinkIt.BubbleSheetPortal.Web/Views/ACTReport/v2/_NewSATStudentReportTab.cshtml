@model LinkIt.BubbleSheetPortal.Web.ViewModels.ACTReport.ACTReportViewModel
<script src="@Url.Content("~/Scripts/TagIt/js/tag-it.js")" type="text/javascript"></script>
<link href="@Url.Content("~/Scripts/TagIt/css/jquery.tagit.css")" rel="stylesheet" type="text/css" />
<link href="@Url.Content("~/Scripts/TagIt/css/tagit.ui-zendesk.css")" rel="stylesheet" type="text/css" />

<style>

    .ui-widget-header .ui-state-hover {
        background: transparent !important;
    }

    .accordion {
        overflow: hidden;
        border: 1px solid var(--blue3);
    }

    .accordion-title {
        border: 0 none;
        background: var(--blue1);
        align-items: center;
        padding: 0.75rem 1rem;
        color: var(--navyColor);
        font-size: var(--fontSizeLabel);
        font-weight: bold;
        text-decoration: none;
        cursor: pointer;
        margin: 0;
    }

    .accordion-title h3 {
        color: var(--navyColor);
        font-weight: 700;
        margin: 0;
    }

    .accordion-title i {
        float: right;
    }

    .accordion-title:focus,
    .accordion-title:hover {
        border-color: var(--blue3);
    }

    .accordion-title.active {
        border-bottom: none;
    }

    .accordion {
        border-radius: 0;
        box-shadow: none;
        padding: 0;
        margin: 0;
        width: calc((50%) - 8px);
    }

    .accordion-content,
    .accordion-content.active {
        border-top: 1px solid var(--blue3);
    }

    .accordion-title.active .fa-chevron-down {
        transition: .3s transform ease-in-out;
        transform: rotate(180deg);
    }

    .accordion-title:not(.active) .fa-chevron-down:not(p) {
        transition: .3s transform ease-in-out;
        transform: rotate(0);
    }

</style>

<div class="mb-4 bg-white p-4 box-shadow">
    <div id="accordion-assignment-setting" class="accordion">
        <div class="accordion-title">
            <h3>Select Test Date Range<i class="fa-solid fa-chevron-down"></i></h3>
        </div>
        <div class="accordion-content">
            <input type="hidden" id="enableDateRangeSAT" value="false" />
            <input type="hidden" id="VirtualTestIdsForAllTestSAT" value="false" />
            <div class="bg-white p-3 form">
                <div class="row g-3">
                    <div class="col-6">
                        <label>From Date</label>
                        <input type="text" id="resultDateFromSAT" class="datepicker full-width" name="resultDateFromSAT" readonly="readonly" />
                    </div>
                    <div class="col-6">
                        <label>To Date</label>
                        <input type="text" id="rresultDateToSAT" class="datepicker full-width" name="resultDateToSAT" readonly="readonly" />
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="d-flex align-items-center mt-3">
        <input type="checkbox" id="chkLimitTestTakingClassSAT" />
        <label for="chkLimitTestTakingClass">Limit to test-taking classes</label>
    </div>
</div>

@if (Model.IsPublisher || Model.IsNetworkAdmin)
{
    <div class="mb-4 bg-white p-4 box-shadow">
        <h3 class="h3">Select State/@LabelHelper.DistrictLabel</h3>
        <div class="row g-3">
            <div class="col-3">
                <div class="block-content-dropdown-marquee">
                    <label>State</label>
                    <div class="block-text-name">
                        <select id="selectStateSAT"></select>
                        <div class="box-select">
                            <span class="overlay"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-3">
                <div class="block-content-dropdown-marquee">
                    <label>@LabelHelper.DistrictLabel</label>
                    <div class="block-text-name">
                        <select id="selectDistrictSAT"></select>
                        <div class="box-select">
                            <span class="overlay"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<div class="mb-4 bg-white p-4 box-shadow">
    <h3 class="h3">Select Test</h3>
    <div class="row g-3">
        <div class="col-6 testListSAT" style="display: none;">
            <div class="wraptag">
                <ul id="selectedTestListSAT" class="tagit ui-widget ui-widget-content ui-corner-all"></ul>
            </div>
        </div>
        <div class="w-100 testListSAT" style="display: none;"></div>
        <div class="col-3">
            <label>@LabelHelper.TestGrade</label>
            <select id="selectGradeSAT"></select>
        </div>
        <div class="col-3">
            <div class="block-content-dropdown-marquee">
                <label>@LabelHelper.Subject</label>
                <div class="block-text-name">
                    <select id="selectSubjectSAT"></select>
                    <div class="box-select">
                        <span class="overlay"></span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-3">
            <div class="block-content-dropdown-marquee">
                <label>Bank</label>
                <div class="block-text-name">
                    <select id="selectBankSAT"></select>
                    <div class="box-select">
                        <span class="overlay"></span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-3">
            <div class="block-content-dropdown-marquee">
                <label>Test</label>
                <div class="block-text-name">
                    <select id="selectTestSAT"></select>
                    <div class="box-select">
                        <span class="overlay"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="mb-4 bg-white p-4 box-shadow">
    <h3 class="h3">Select Students</h3>
    <div id="divSingleClassSummary" class="row g-3">
        <div class="col-3">
            <div class="block-content-dropdown-marquee">
                <label>School</label>
                <div class="block-text-name">
                    <select id="selectSchoolSAT"></select>
                    <div class="box-select">
                        <span class="overlay"></span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-3">
            <div class="block-content-dropdown-marquee">
                <label>Teacher</label>
                <div class="block-text-name">
                    <select id="selectTeacherSAT"></select>
                    <div class="box-select">
                        <span class="overlay"></span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-3">
            <div class="block-content-dropdown-marquee">
                <label>@LabelHelper.Term</label>
                <div class="block-text-name">
                    <select id="selectTermSAT"></select>
                    <div class="box-select">
                        <span class="overlay"></span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-3">
            <div class="block-content-dropdown-marquee">
                <label>Class</label>
                <div class="block-text-name">
                    <select id="selectClassSAT"></select>
                    <div class="box-select">
                        <span class="overlay"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="studentContentSAT" class="block-section-custom mb-4" style="display: none">
    <div class="student-content-wrapper">
        <button type="button" name="select-all" onclick="selectAllStudentsSAT()">Select All</button>
        <button type="button" name="select-none" onclick="selectNoStudentsSAT()">Select None</button>
        <button type="button" name="invert-select" onclick="invertSelectedStudentsSAT()">Invert Selection</button>
    </div>
    <div class="mt-4">
        <div id="studentsListSAT">
            <ul id="studentsSAT" class="generate-student-list generate-student-list-custom with-icon icon-user student-col"></ul>
        </div>
    </div>
</div>
<div id="divMultiClassSAT" style="display: none;">
</div>

<div class="mb-4 bg-white p-4 box-shadow">
    <h3 class="h3">Report Content Options</h3>
    <div class="row g-3">
        <div class="col-3">
            <label>Options</label>
            <select id="selectReportContentOption">
                <option value="1">Include scores only</option>
                <option value="2">Include scores and essays</option>
                <option value="3">Include essays only</option>
            </select>
        </div>
    </div>
</div>

@if (Model.IncludeStateInformation)
{
    <div class="mb-4 bg-white p-4 box-shadow">
        <h3 class="h3">Report Content Options</h3>
        <div class="row g-3">
            <div class="col-3">
                <label>Include State Information</label>
                <select id="selectStateInformation">
                </select>
            </div>
        </div>
    </div>
}

<div class="text-end bg-white p-4 box-shadow">
    <button class="btn-red" id="btnSubmitSAT" type="button">Generate</button>
</div>

<script type="text/javascript">
    var selectedTagsDictSAT = {};
    $.ajaxSetup({ cache: false });
    function beforeTagItAdded() {
        var tagId = $('#selectTestSAT').val();
        if (tagId != undefined && tagId != 'select') {
            // Clear "All tests" tag when adding 1st item
            if (countSelectedTagsSAT() == 0) {
                $('#selectedTestListSAT .tagit-choice').hide();
            }

            selectedTagsDictSAT[$('#selectTestSAT option:selected').text()] = tagId; //remember Id of selected tag
        }
    }
    $(function () {

        $('#accordion-assignment-setting .accordion-title').on('click', function () {
            var $self = $(this);
            var $accordionContent = $self.next();

            if ($self.hasClass('active')) {
                $self.removeClass('active');
                hidedateRangeContentSAT();
                $accordionContent.slideUp();
            } else {
                $self.addClass('active');
                showdateRangeContentSAT();
                $accordionContent.slideDown();

            }
        });

        var marqueeTemplateEl = $('#marqueeTemplate').width() - 5 || 250;
        $('#selectStateSAT').marquee({ widthSelected: marqueeTemplateEl });
        $('#selectDistrictSAT').marquee({ widthSelected: marqueeTemplateEl });
        $('#selectSubjectSAT').marquee({ widthSelected: marqueeTemplateEl });
        $('#selectBankSAT').marquee({ widthSelected: marqueeTemplateEl });
        $('#selectTestSAT').marquee({ widthSelected: marqueeTemplateEl });
        $('#selectSchoolSAT').marquee({ widthSelected: marqueeTemplateEl });
        $('#selectTeacherSAT').marquee({ widthSelected: marqueeTemplateEl });
        $('#selectTermSAT').marquee({ widthSelected: marqueeTemplateEl });
        $('#selectClassSAT').marquee({ widthSelected: marqueeTemplateEl });
        var reportType = $('#reportType').val();

        function showdateRangeContentSAT() {
            $('#enableDateRangeSAT').val('true');
            $('.testListSAT').show();

            clearSelectTestTabSAT();
            clearSelectStudentTabSAT();
            populateGradesSAT();
        }

        function hidedateRangeContentSAT() {
            $('#enableDateRangeSAT').val('false');
            $('.testListSAT').hide();

            clearSelectTestTabSAT();
            clearSelectStudentTabSAT();
            populateGradesSAT();
        }


        $("#selectedTestListSAT").tagit({
            beforeTagAdded: function (event, ui) {

            },
            beforeTagRemoved: function (event, ui) {
                //clear the selected tag out of memory
                delete selectedTagsDictSAT[ui.tagLabel];

                updateSelectedTestsSAT();
                clearSelectStudentTabSAT();
                populateTestsSAT();
            }
        });
        $('#selectedTestListSAT').find('.ui-autocomplete-input').attr('readonly', true); // Disallow to type into selected test tagit

        $('input[name="resultDateFromSAT"]').datepicker({
            dateFormat: jqueryDatePickerFormat(),
            beforeShow: function(input, inst) {
                $('#ui-datepicker-div').addClass('datepicker-sgo');
            }
        }).datepicker('setDate', '@Model.ResultDateFrom');

        $('input[name="resultDateToSAT"]').datepicker({
            dateFormat: jqueryDatePickerFormat(),
            beforeShow: function(input, inst) {
                $('#ui-datepicker-div').addClass('datepicker-sgo');
            }
        }).datepicker('setDate', '@Model.ResultDateTo');

        @if (Model.IsPublisher)
        {
            <text>
        $.get('@Url.Action("GetStates", "PopulateStateDistrict")', function (states) {
            populateStatesSAT(states);
        });

        </text>
        }
        else if (Model.IsNetworkAdmin)
        {
            <text>
            $.get('@Url.Action("GetStatesForNetworkAdmin", "PopulateStateDistrict")', function (states) {
                populateStatesSAT(states);
            });
            </text>
        }
        else
        {
            <text>
                populateGradesSAT();
            </text>
        }

        $('#resultDateFromSAT').change(function () {
            reloadContentWhenChangingResultDateSAT();
        });

        $('#resultDateToSAT').change(function () {
            reloadContentWhenChangingResultDateSAT();
        });

        function reloadContentWhenChangingResultDateSAT() {
            clearSelectTestTabSAT();
            clearSelectStudentTabSAT();
            populateGradesSAT();
        }

        $('#selectStateSAT').change(function () {
            $('#selectDistrictSAT').empty();
            clearSelectTestTabSAT();
            clearSelectStudentTabSAT();

            if ($('#selectStateSAT').val() != 'select') {
                populateDistrictsSAT();
            }
        });

        $('#selectDistrictSAT').change(function () {
            clearSelectTestTabSAT();
            clearSelectStudentTabSAT();

            populateGradesSAT();
        });

        $('#selectGradeSAT').change(function () {
            $('#selectSubjectSAT').empty();
            $('#selectBankSAT').empty();
            $('#selectTestSAT').empty();

            updateSelectedTestsSAT();
            clearSelectStudentTabSAT();

            populateSubjectsSAT();
        });

        $('#selectSubjectSAT').change(function () {
            $('#selectBankSAT').empty();
            $('#selectTestSAT').empty();

            updateSelectedTestsSAT();
            clearSelectStudentTabSAT();
            populateBanksSAT();
        });

        $('#selectBankSAT').change(function () {
            $('#selectTestSAT').empty();

            updateSelectedTestsSAT();
            clearSelectStudentTabSAT();
            populateTestsSAT();
        });

        $('#selectTestSAT').change(function () {
            clearSelectStudentTabSAT();
            if ($('#enableDateRangeSAT').val() == 'true') {
                var testId = $('#selectTestSAT').val();
                if (testId != 'select' && testId != '') {
                    beforeTagItAdded();
                    $("#selectedTestListSAT").tagit("createTag", $('#selectTestSAT option:selected').text());
                    $('#selectTestSAT option:selected').remove();
                }
            }

            if (getSelectedTagsSAT() != '') {

                var virtualTestIdString = getSelectedTagsSAT();
                var vSelectDistrict = $('#selectDistrictSAT').val();
                var resultDateFrom = getResultDateFromSAT();
                var resultDateTo = getResultDateToSAT();
                var isGetAllClass = getIsGetAllClassSAT();

                $.get('@Url.Action("MultipleTestGetSchools", "PopulateReporting")', { virtualTestIdString: virtualTestIdString, districtId: vSelectDistrict, virtualTestSubTypeId: getVirtualTestSubTypeId(), resultDateFrom: resultDateFrom, resultDateTo: resultDateTo, isGetAllClass: isGetAllClass }, function (schools) {
                    if ($('#selectDistrictSAT').val() != 'select') { // Check incase ajax returns after user unselect district dropdown
                        populateSchoolsSAT(schools);
                    }
                });
            }
        });

        $('#btnPublishTestSAT').click(function () {
            if (getSelectedTagsSAT() == '') {
                //CustomAlert('No test is selected.');
                return;
            }

            clearSelectStudentTabSAT();

            var virtualTestIdString = getSelectedTagsSAT();
            var vSelectDistrict = $('#selectDistrictSAT').val();
            var resultDateFrom = getResultDateFromSAT();
            var resultDateTo = getResultDateToSAT();

            $.get('@Url.Action("MultipleTestGetSchools", "PopulateReporting")', { virtualTestIdString: virtualTestIdString, districtId: vSelectDistrict, virtualTestSubTypeId: getVirtualTestSubTypeId(), resultDateFrom: resultDateFrom, resultDateTo: resultDateTo }, function (schools) {
                    populateSchoolsSAT(schools);
                });
        });

        $('#selectSchoolSAT').change(function () {
            $('#selectTeacherSAT').empty();
            $('#selectTermSAT').empty();
            $('#selectClassSAT').empty();
            $('#studentContentSAT').hide();
            if ($('#selectSchoolSAT').val() != 'select') {
                populateTeachersSAT();
            }
        });

        $('#selectTeacherSAT').change(function () {
            $('#selectClassSAT').empty();
            $('#selectTermSAT').empty();
            $('#studentContentSAT').hide();
            $('#studentsSAT').html('');

            if ($('#selectTeacherSAT').val() != 'select') {
                populateTermsSAT();
            }
        });

        $('#selectTermSAT').change(function () {
            populateClassesSAT();
        });

        $('#selectClassSAT').change(function () {
            populateStudentsSAT();
        });

        $('#btnSubmitSAT').click(function (e) {

            if (getSelectedTagsSAT() == '0') {
                CustomAlert('No test is selected.');
                return;
            }

            if (getIsGetAllClassSAT()) {
                var classValue = $('#selectClassSAT').val();
                var isClassSelected = classValue != 'select' && classValue != '' && classValue != null;

                if (!isClassSelected) {
                    CustomAlert('Please select a class to generate report.');
                    return;
                }
            }

            //clear error message
            $("#error-messages").html('');
            $("#error-messages").hide();


            //ShowBlock($('#ACTPageContent'), "Generating reports");

            $('#btnSubmitSAT').disableBt();
            ShowBlock($('#dataTable'), 'Generating reports');


            var studentsIdSelected = [];

            $(".student-item[isSelected=yes]").each(function () {
                studentsIdSelected.push($(this).attr('studentId'));
            });

            var timezoneOffset = new Date().getTimezoneOffset();
            var reportFileName = "SAT_" + (new Date()).toString("MM-dd-HH-mm") + "_" + getRandomString();
            var reportingUrl = '@Url.Action("CheckGenerateNewSATRequest", "SATReportOld")';

            if (reportType == 'SATStudentReportNewTemplate') {
                reportingUrl = '@Url.Action("CheckGenerateNewSATRequest", "SATReport")';
            }
            var isGetAllClass = getIsGetAllClassSAT();

            var data = {
                StrTestIdList: getSelectedTagsSAT,
                DistrictId: $('#selectDistrictSAT').val(),
                SchoolId: $('#selectSchoolSAT').val(),
                TeacherId: $('#selectTeacherSAT').val(),
                DistrictTermId: $('#selectTermSAT').val(),
                ClassId: $('#selectClassSAT').val(),
                ResultDateFrom: getResultDateFromSAT(),
                ResultDateTo: getResultDateToSAT(),
                StudentIdList: studentsIdSelected,
                TimezoneOffset: timezoneOffset,
                ActReportFileName: reportFileName,
                ReportContentOption: $('#selectReportContentOption').val(),
                StateInformationId: $('#selectStateInformation').val(),
                isGetAllClass: isGetAllClass
            };

            $.ajax({
                url: reportingUrl,
                traditional: true,
                type: 'POST',
                data: data,
                success: function (response) {
                    if (response.Result == true) {
                        $('#error-messages').hide();

                        $.ajax({
                            url: '@Url.Action("StoreSpecializedReportJobSession","AccessSession")/?specializedReportJobId=' + response.SpecializedReportJobId,
                            traditional: true,
                            type: 'POST',
                            data: data,
                            success: function (response) {
                                startLoadingSpecializedReportJob(); // PopulateReporting/_SpecializedReportDownload.cshtml
                            }
                        });

                        reportingUrl = '@Url.Action("GenerateNewSAT", "SATReportOld")';

                        if (reportType == 'SATStudentReportNewTemplate') {
                             reportingUrl = '@Url.Action("GenerateNewSAT", "SATReport")';
                        }

                        var isGetAllClass = getIsGetAllClassSAT();

                        data = {
                            StrTestIdList: getSelectedTagsSAT,
                            DistrictId: $('#selectDistrictSAT').val(),
                            SchoolId: $('#selectSchoolSAT').val(),
                            TeacherId: $('#selectTeacherSAT').val(),
                            DistrictTermId: $('#selectTermSAT').val(),
                            ClassId: $('#selectClassSAT').val(),
                            ResultDateFrom: getResultDateFromSAT(),
                            ResultDateTo: getResultDateToSAT(),
                            StudentIdList: studentsIdSelected,
                            TimezoneOffset: timezoneOffset,
                            ActReportFileName: reportFileName,
                            ReportContentOption: $('#selectReportContentOption').val(),
                            StateInformationId: $('#selectStateInformation').val(),
                            SpecializedReportJobId: response.SpecializedReportJobId,
                            isGetAllClass: isGetAllClass
                        };

                        $.ajax({
                            url: reportingUrl,
                            traditional: true,
                            type: 'POST',
                            data: data,
                            success: function (data) {
                                if (!data.IsSuccess && !data.Url) {
                                    CustomAlert("The report could not be generated because the students selected do not have essays.");
                                }
                            }
                        });
                    } else {
                        CustomAlert('Your submitted test result of ' + response.SubmittedTestResult + ' is greater than maximum allowed of ' + response.MaxTestResult + '. Please update your filter and submit again.', true);
                        $('#ACTPageContent').unblock();
                        $('#btnSubmitSAT').enableBt();
                    }
                },
                failure: function (response) {
                    $('#ACTPageContent').unblock();
                    $('#btnSubmitSAT').enableBt();
                },
                timeout: 300000
            });
        });
    });

    function getRandomString() {
        return Math.random().toString(36).substring(2, 14);
    }

    function populateDistrictsSAT() {
        $('#selectDistrictSAT').empty();
        var stateValue = $('#selectStateSAT').val();
        if (stateValue != 'select') {
            @if (Model.IsPublisher)
            {
                <text>
            $.get('@Url.Action("GetDistricts", "PopulateStateDistrict")', { stateId: stateValue }, function (districts) {
                addDefaultOption($('#selectDistrictSAT'), "@LabelHelper.DistrictLabel");
                addSelectListItems($('#selectDistrictSAT'), districts);
            });
            </text>
            }
            else if (Model.IsNetworkAdmin)
            {
                <text>
            $.get('@Url.Action("GetDistrictsForNetworkAdmin", "PopulateStateDistrict")', { stateId: stateValue }, function (districts) {
                addDefaultOption($('#selectDistrictSAT'), "@LabelHelper.DistrictLabel");
                addSelectListItems($('#selectDistrictSAT'), districts);
            });
             </text>
            }

        }
    }

    function populateGradesSAT() {
        $('#selectGradeSAT').empty();
        $('#selectSubjectSAT').empty();
        $('#selectBankSAT').empty();
        $('#selectTestSAT').empty();
        var resultDateFrom = getResultDateFromSAT();
        var resultDateTo = getResultDateToSAT();

        var districtValue = "-1";
        if ($('#selectDistrictSAT').length > 0) {
            districtValue = $('#selectDistrictSAT').val();
        }

        if (districtValue != 'select' && districtValue != null) {
            $.get('@Url.Action("GetGrades", "PopulateReporting")', { districtId: districtValue, virtualTestSubTypeId: getVirtualTestSubTypeId(), resultDateFrom: resultDateFrom, resultDateTo: resultDateTo, isGetAllClass: getIsGetAllClassSAT() }, function (grades) {
                if ($('#selectDistrictSAT').val() != 'select') { // Check incase ajax returns after user unselect district dropdown
                    addDefaultOption($('#selectGradeSAT'), "@LabelHelper.TestGrade");
                    addSelectListItems($('#selectGradeSAT'), grades);

                    getAndAssignAllTestListSAT();
                }
            });
        }
    }

    function populateSubjectsSAT() {
        resetSubjectsSAT();
        var gradeValue = $('#selectGradeSAT').val();
        var districtValue = 0;
        if ($('#selectDistrictSAT').length && $('#selectDistrictSAT').val() != null && $('#selectDistrictSAT').val() != 'select') {
            districtValue = $('#selectDistrictSAT').val();
        }
        var resultDateFrom = getResultDateFromSAT();
        var resultDateTo = getResultDateToSAT();;

        if (gradeValue != 'select') {
            $.get('@Url.Action("GetSubjects", "PopulateReporting")', { gradeId: gradeValue, districtId: districtValue, virtualTestSubTypeId: getVirtualTestSubTypeId(), resultDateFrom: resultDateFrom, resultDateTo: resultDateTo, isGetAllClass: getIsGetAllClassSAT() }, function (subjects) {
                if ($('#selectDistrictSAT').val() != 'select') { // Check incase ajax returns after user unselect district dropdown
                    addDefaultOption($('#selectSubjectSAT'), "@LabelHelper.Subject");
                    addSelectListItems($('#selectSubjectSAT'), subjects);

                    //getAndAssignAllTestListSAT();
                }
            });
        }
    }

    function populateBanksSAT() {
        resetBanksSAT();
        var subjectValue = $('#selectSubjectSAT').val();
        var resultDateFrom = getResultDateFromSAT();
        var resultDateTo = getResultDateToSAT();
        var districtValue = 0;
        if ($('#selectDistrictSAT').length && $('#selectDistrictSAT').val() != null && $('#selectDistrictSAT').val() != 'select') {
            districtValue = $('#selectDistrictSAT').val();
        }
        if (subjectValue != 'select') {
            $.get('@Url.Action("GetBanks", "PopulateReporting")', { subjectIds: subjectValue, districtId: districtValue, virtualTestSubTypeId: getVirtualTestSubTypeId(), resultDateFrom: resultDateFrom, resultDateTo: resultDateTo, isGetAllClass: getIsGetAllClassSAT() }, function (banks) {
                if ($('#selectDistrictSAT').val() != 'select') { // Check incase ajax returns after user unselect district dropdown
                    addDefaultOption($('#selectBankSAT'), "Bank");
                    addSelectListItems($('#selectBankSAT'), banks);

                    getAndAssignAllTestListSAT();
                }
            });
        }
    }

    // Load and assign all test list to use when query school, teacher, term, class and submit test all All test is selected
    function getAndAssignAllTestListSAT() {
        if ($('#enableDateRangeSAT').val() == 'true') {
            var districtValue = 0;
            if ($('#selectDistrictSAT').length && $('#selectDistrictSAT').val() != null && $('#selectDistrictSAT').val() != 'select') {
                districtValue = $('#selectDistrictSAT').val();
            }

            var gradeValue = $('#selectGradeSAT').val();
            var subjectValue = $('#selectSubjectSAT').val();
            var bankValue = $('#selectBankSAT').val();
            var resultDateFrom = getResultDateFromSAT();
            var resultDateTo = getResultDateToSAT();

            $.get('@Url.Action("MultipleTestGetTests", "PopulateReporting")', { gradeId: gradeValue, subjectId: subjectValue, bankId: bankValue, districtId: districtValue, virtualTestSubTypeId: getVirtualTestSubTypeId(), resultDateFrom: resultDateFrom, resultDateTo: resultDateTo, isGetAllClass: getIsGetAllClassSAT() }, function (tests) {
                if ($('#selectDistrictSAT').val() != 'select') { // Check incase ajax returns after user unselect district dropdown
                    var values = [];

                    for (var i = 0; i < tests.length; i++) {
                        values.push(tests[i].Id);
                    }

                    $('#VirtualTestIdsForAllTestSAT').val(values.join(','));
                    $('#selectTestSAT').trigger('change'); // call to reload school
                }
            });
        }
    }


    function populateTestsSAT() {
        $('#selectTestSAT').empty();
        var bankValue = $('#selectBankSAT').val();
        if (bankValue != null && bankValue != 'select') {
            var districtValue = 0;
            if ($('#selectDistrictSAT').length && $('#selectDistrictSAT').val() != null && $('#selectDistrictSAT').val() != 'select') {
                districtValue = $('#selectDistrictSAT').val();
            }
            var resultDateFrom = getResultDateFromSAT();
            var resultDateTo = getResultDateToSAT();

            $.get('@Url.Action("MultipleTestGetTests", "PopulateReporting")', { bankId: bankValue, districtId: districtValue, virtualTestSubTypeId: getVirtualTestSubTypeId(), resultDateFrom: resultDateFrom, resultDateTo: resultDateTo, isGetAllClass: getIsGetAllClassSAT() }, function (tests) {
                if ($('#selectDistrictSAT').val() != 'select') { // Check incase ajax returns after user unselect district dropdown
                    // Remove selected tests out of return list
                    for (var i = tests.length - 1; i >= 0; i--) {
                        if (selectedTagsDictSAT[tests[i].Name] != undefined) {
                            tests.splice(i, 1);
                        }
                    }

                    addDefaultOption($('#selectTestSAT'), "Test");
                    addSelectListWithDefaultValue($('#selectTestSAT'), tests);

                    addTagAllTest();
                    enableDisablePublishStudentButtonSAT();
                    $('#selectTestSAT').trigger('change');
                }
            });
        }
    }

    function populateSchoolsSAT(schools) {
        $('#selectSchoolSAT').empty();
        addDefaultOption($('#selectSchoolSAT'), "School");
        addSelectListItems($('#selectSchoolSAT'), schools);
    }

    function populateTeachersSAT() {
        $('#selectTeacherSAT').empty();
        var districtValue = $('#selectDistrictSAT').val();
        var schoolValue = $('#selectSchoolSAT').val();
        var resultDateFrom = getResultDateFromSAT();
        var resultDateTo = getResultDateToSAT();
        var isGetAllClass = getIsGetAllClassSAT();

        if (schoolValue != 'select') {
            $.get('@Url.Action("MultipleTestGetTeachers", "PopulateReporting")', { districtId: districtValue, schoolId: schoolValue, virtualtestIdString: getSelectedTagsSAT(), virtualTestSubTypeId: getVirtualTestSubTypeId(), resultDateFrom: resultDateFrom, resultDateTo: resultDateTo, isGetAllClass: isGetAllClass }, function (teachers) {
                if ($('#selectDistrictSAT').val() != 'select') { // Check incase ajax returns after user unselect district dropdown
                    addDefaultOption($('#selectTeacherSAT'), "Teacher");
                    addSelectListWithDefaultValue($('#selectTeacherSAT'), teachers, 'select', function(item) {
                        return (item.FirstName) ? item.LastName + ", " + item.FirstName + " (" + item.Name + ")" : item.LastName + " (" + item.Name + ")";
                    });
                }
            });
        }
    }

    //if check this checkbox, get all classes, fill to class dropdown, and empty other dropdowns
    $("#chkLimitTestTakingClassSAT")
        .change(function () {
            clearSelectTestTabSAT();
            clearSelectStudentTabSAT();
            populateGradesSAT();
        });

    function populateClassesSAT() {
        $('#selectClassSAT').empty();
        $('#studentsSAT').html('');
        var districtValue = $('#selectDistrictSAT').val();
        var schoolValue = $('#selectSchoolSAT').val();
        var termValue = $('#selectTermSAT').val();
        var teacherValue = $('#selectTeacherSAT').val();
        var virtualTestIdString = getSelectedTagsSAT();
        var resultDateFrom = getResultDateFromSAT();
        var resultDateTo = getResultDateToSAT();
        var isGetAllClass = getIsGetAllClassSAT();

        if (termValue != 'select') {
            $.get('@Url.Action("MultipleTestGetClasses", "PopulateReporting")', { districtId: districtValue, schoolId: schoolValue, termId: termValue, userId: teacherValue, virtualTestIdString: virtualTestIdString, virtualTestSubTypeId: getVirtualTestSubTypeId(), resultDateFrom: resultDateFrom, resultDateTo: resultDateTo, isGetAllClass: isGetAllClass }, function (classes) {
                if ($('#selectDistrictSAT').val() != 'select') { // Check incase ajax returns after user unselect district dropdown
                    addDefaultOption($('#selectClassSAT'), "Class");
                    addSelectListItems($('#selectClassSAT'), classes);
                }
            });
        }
    }

    function populateAllClassesSAT() {
        $('#selectClassSAT').empty();
        $('#studentsSAT').html('');
        var districtValue = $('#selectDistrictSAT').val();
        var virtualTestIdString = getSelectedTagsSAT();
        var resultDateFrom = getResultDateFromSAT();
        var resultDateTo = getResultDateToSAT();

        $.get('@Url.Action("MultipleTestGetAllClasses", "PopulateReporting")', { districtId: districtValue, virtualTestIdString: virtualTestIdString, virtualTestSubTypeId: getVirtualTestSubTypeId(), resultDateFrom: resultDateFrom, resultDateTo: resultDateTo }, function (classes) {
            if ($('#selectDistrictSAT').val() != 'select') { // Check incase ajax returns after user unselect district dropdown
                addDefaultOption($('#selectClassSAT'), "Class");
                addSelectListItems($('#selectClassSAT'), classes);
            }
        });
    }

    function populateStudentsSAT() {
        var classValue = $('#selectClassSAT').val();
        var virtualTestIdString = getSelectedTagsSAT();
        var resultDateFrom = getResultDateFromSAT();
        var resultDateTo = getResultDateToSAT();
        var isGetAllClass = getIsGetAllClassSAT();

        if (classValue != 'select') {
            $('#studentContentSAT').show();
            if (reportType == 'SATStudentReportNewTemplate') {
                $.get('@Url.Action("MultipleTestSATGetStudents", "SATReportOld")', { classId: classValue, virtualTestIdString: virtualTestIdString, resultDateFrom: resultDateFrom, resultDateTo: resultDateTo, isGetAllClass: isGetAllClass }, function (students) {
                $('#studentsSAT').html('');
                addStudentsToListSAT($('#studentsSAT'), students);
                selectAllStudentsSAT();
            });
            }
            else {
                $.get('@Url.Action("MultipleTestSATGetStudents", "SATReport")', { classId: classValue, virtualTestIdString: virtualTestIdString, resultDateFrom: resultDateFrom, resultDateTo: resultDateTo, isGetAllClass: isGetAllClass }, function (students) {
                $('#studentsSAT').html('');
                addStudentsToListSAT($('#studentsSAT'), students);
                selectAllStudentsSAT();
            });
            }

        } else {
            $('#studentContentSAT').hide();
        }
    }

    function populateStatesSAT(states) {
        addDefaultOption($('#selectStateSAT'), "State");
        addSelectListItems($('#selectStateSAT'), states);
    }

    function populateStateInformation(states) {
        addDefaultOption($('#selectStateInformation'), "State");
        addSelectListItems($('#selectStateInformation'), states);
    }

    function addStudentsToListSAT(el, students) {
        var $el = $(el);
        var studentHtml = [];

        for (var i = 0, len = students.length; i < len; i++) {
            var student = students[i];
            studentHtml.push('<li studentId="' + student.StudentId + '" class="student-item"><a href="javascript:void(0)">' + student.FullName + '</a></li>');
        }

        $el.html(studentHtml.join(''));
    }

    function resetSubjectsSAT() {
        $('#selectSubjectSAT').empty();
        resetBanksSAT();
    }

    function resetBanksSAT() {
        $('#selectBankSAT').empty();
        $('#selectTestSAT').empty();
    }

    function selectAllStudentsSAT() {
        $('.student-col').children().attr('isselected', "yes");
        $('.student-col').children().css('background-color', "#82CAFA");
    }

    function selectNoStudentsSAT() {
        $('.student-col').children().attr('isselected', "no");
        $('.student-col').children().css('background-color', "#f2f2f2");
    }

    function invertSelectedStudentsSAT() {
        $('.generate-student-list li').each(function () {
            if ($(this).attr('isselected') == "yes") {
                $(this).attr('isselected', "no");
                $(this).css('background-color', "#f2f2f2");
            } else {
                $(this).attr('isselected', "yes");
                $(this).css('background-color', "#82CAFA");
            }
        });
    }

    function populateTermsSAT() {
        $('#selectTermSAT').empty();

        var districtValue = $('#selectDistrictSAT').val();
        var schoolValue = $('#selectSchoolSAT').val();
        var teacherValue = $('#selectTeacherSAT').val();
        var virtualTestIdString = getSelectedTagsSAT();
        var resultDateFrom = getResultDateFromSAT();
        var resultDateTo = getResultDateToSAT();
        var isGetAllClass = getIsGetAllClassSAT();

        $.get('@Url.Action("MultipleTestGetTerms", "PopulateReporting")', { districtId: districtValue, virtualTestIdString: virtualTestIdString, userId: teacherValue, schoolId: schoolValue, virtualTestSubTypeId: getVirtualTestSubTypeId(), resultDateFrom: resultDateFrom, resultDateTo: resultDateTo, isGetAllClass: isGetAllClass }, function (terms) {
            if ($('#selectDistrictSAT').val() != 'select') { // Check incase ajax returns after user unselect district dropdown
                addDefaultOption($('#selectTermSAT'), "@LabelHelper.Term");
                addSelectListItems($('#selectTermSAT'), terms);
            }
        });

    }

    function getSelectedTagsSAT() {
        var virtualTestIds = '0';

        if ($('#selectDistrictSAT').val() != 'select') { // Check incase ajax returns after user unselect district dropdown
            if ($('#enableDateRangeSAT').val() == 'true') {
                var x = '';
                for (var key in selectedTagsDictSAT) {
                    x += selectedTagsDictSAT[key] + ',';
                }

                if (x.length > 0)
                    virtualTestIds = x.substring(0, x.length - 1); // return list of selected tests
                else {
                    var values = [];
                    $('#selectTestSAT  option').each(function() {
                        if ($(this).attr('value') != 'select')
                            values.push($(this).attr('value'));
                    });

                    if (values.length > 0) {
                        virtualTestIds = values.join(','); // return list of virtual test in test dropdown when bank is selected
                    } else {
                        virtualTestIds = $('#VirtualTestIdsForAllTestSAT').val(); // return list of virtual test when all test is selected
                    }
                }
            } else {
                virtualTestIds = $('#selectTestSAT').val();
            }

            if (virtualTestIds == 'select' || virtualTestIds == '' || virtualTestIds == null || virtualTestIds == 'null')
                return '0';
        }

        return virtualTestIds;
    }

    function getResultDateFromSAT() {
        if ($('#enableDateRangeSAT').val() == 'true') {
            return $('#resultDateFromSAT').val();
        }
        return '';
    }

    function getResultDateToSAT() {
        if ($('#enableDateRangeSAT').val() == 'true') {
            return $('#resultDateToSAT').val();
        }
        return '';
    }

    function getIsGetAllClassSAT() {
        var isGetAllClass = !$("#chkLimitTestTakingClassSAT").is(':checked');
        return isGetAllClass;
    }


    function countSelectedTagsSAT() {
        try {
            var count = 0;
            for (var key in selectedTagsDictSAT) {
                count++;
            }

            return count;
        }
        catch (err) {
            return 0;
        }

    }

    function resetSelectedTestsSAT() {
        selectedTagsDictSAT = {};
        $('#selectedTestListSAT .tagit-choice').hide();
        $('#btnPublishTestSAT').attr('disabled', 'disabled');
    }

    // Clear or Add "All tests" tag based on selected tests data. is called inside "Select Test" box
    function updateSelectedTestsSAT() {
        if ($('#enableDateRangeSAT').val() == 'true') {
            addTagAllTest()
            enableDisablePublishStudentButtonSAT();
        }
    }

    function addTagAllTest() {
        // Add "All tests" tag when tag list is empty
        var tagAdded = $('#selectedTestListSAT').tagit('assignedTags') || [];
        var tagValue = 'All tests';
        if (countSelectedTagsSAT() == 0 && tagAdded.indexOf(tagValue) == -1) {
            beforeTagItAdded('updateSelectedTestsSAT', this);
            $('#selectedTestListSAT').tagit('createTag', 'All tests');
        }
    }

    function enableDisablePublishStudentButtonSAT() {
        if (getSelectedTagsSAT() == '') {
            $('#btnPublishTestSAT').attr('disabled', 'disabled');
        } else {
            $('#btnPublishTestSAT').enableBt();
        }
    }

    function clearSelectStudentTabSAT() {
        $("#selectSchoolSAT").find('option').removeAttr("selected");
        $('#selectSchoolSAT').empty();

        $("#selectTeacherSAT").find('option').removeAttr("selected");
        $('#selectTeacherSAT').empty();

        $("#selectTermSAT").find('option').removeAttr("selected");
        $('#selectTermSAT').empty();

        $("#selectClassSAT").find('option').removeAttr("selected");
        $('#selectClassSAT').empty();

        $('#studentContentSAT').hide();
        $('#studentsSAT').html('');
    }

    function clearSelectTestTabSAT() {
        $("#selectGradeSAT").find('option').removeAttr("selected");
        $('#selectGradeSAT').empty();

        $("#selectSubjectSAT").find('option').removeAttr("selected");
        $('#selectSubjectSAT').empty();

        $("#selectBankSAT").find('option').removeAttr("selected");
        $('#selectBankSAT').empty();

        $("#selectTestSAT").find('option').removeAttr("selected");
        $('#selectTestSAT').empty();
        resetSelectedTestsSAT();
    }
</script>
