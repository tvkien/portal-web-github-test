@model  LinkIt.BubbleSheetPortal.Models.SGO.VirtualTestCustomScore
<style type="text/css">
    tr.even.row_selected td {
        background-color: #82CAFA !important;
    }

    tr.odd.row_selected td {
        background-color: #82CAFA !important;
    }

    #dataTableOverallScore_wrapper {
        margin-top: 34px;
    }

    #dataTableOverallScore tbody tr {
    }

    #dataTableOverallScore tr td {
        padding-left: 4px;
        padding-right: 4px;
    }

    #dataTableOverallScore_info, #dataTableOverallScore_length {
        display: none;
    }

    #dataTableOverallScore {
        width: auto;
    }

    .word-break {
        word-break: break-all;
    }

    .list-initial ul,
    .list-initial ol {
        list-style: initial;
        padding-left: 30px;
    }

    .qtip-content ul,
    .qtip-content ol {
        list-style: initial;
        padding-left: 30px;
    }

    #dataTableOverallScore_wrapper .sindu_dragger table td {
        padding: 0.75em 4px;
    }

    #dataTableOverallScore_wrapper #dataTableOverallScore {
        margin-top: -1.667em;
    }

    .ui-sortable-helper {
        display: flex !important;
    }

    .disabled-drag {
        cursor: no-drop;
    }

    .custom-popup button {
        width: auto !important;
    }
</style>
<div class="block-content form" id="divOverallScoreContainer" style="background-color: #fcfcfc;">
    <h1>
        Score Column
        @if (!Model.HasAssociatedTestResult)
        {
            <a href="javascript:void(0)" class="CreateOverallScore">
                <img src="@Url.Content("~/Content/themes/Constellation/images/icons/fugue/plus-circle-blue.png")" />
                Add Score Column
            </a>
        }

        <div class="clearfix"></div>
    </h1>
    <table id="dataTableOverallScore" class="datatable table no-margin" table-id="@Model.VirtualTestCustomScoreId" table-scoreid="@(Model.VirtualTestCustomScoreId)" table-type="overall">
        <thead>
            <tr>
                <th scope="col"></th>
                <th scope="col">
                    <span class="column-sort">
                        <a href="javascript:void(0)" title="Sort Up" class="sort-up"></a>
                        <a href="javascript:void(0)" title="Sort Down" class="sort-down"></a>
                    </span>
                    Name
                </th>
                <th scope="col">Type</th>
                <th scope="col">Description</th>
                <th scope="col">Validation Properties</th>
            </tr>
        </thead>
        <tbody class="connectedSortable" style="cursor: pointer"></tbody>
    </table>
</div>

<script type="text/javascript">
    var overalScoreColumnForCalculate = [];
    var overallCalculateDetail = [];
    var overallRawMaxScore = null;
    var oTableOverallScore;
    var keepCurrentPageOverallScore = 0;
    var displayStartOverallScore = 0;
    var hasPercentScoreAutoOverall = false;
    var hasRawOverallAuto = false;
    var hasAssociatedTestResult = '@Model.HasAssociatedTestResult';
    var hasAssociatedAutoSave = '@Model.HasAssociatedAutoSave';
    var listDisableScore = [];
    var listDisableSub = [];
    var listSubScoreNeedReload = [];

    $(function() {
        removeTips();
        var options = {
            bServerSide: true,
            bDestroy: true,
            bStateSave: false,
            bFilter:false,
            sAjaxSource: getAjaxSourceScoreTypeList(),
            fnServerParams: function(aoData) {
                //TuanVo:encode text in filter searchbox
                var item = null;
                for (var i = 0; i < aoData.length; i++) {
                    item = aoData[i];
                    if (item.name == 'sSearch') {
                        do {
                            item.value = item.value.replace('""', '"');
                        } while (item.value.indexOf('""') >= 0)

                        if (item.value == '"') {
                            item.value = item.value.replace('"', "''"); // when user type " or "", or """,...in searchbox, system will issue an error, this code fix that error
                        } else {
                            item.value = encodeURIComponent(item.value);
                        }
                        break;
                    }
                }
            },
            bAutoWidth: false,
            iDisplayLength: 1000,
            aaSorting: [[0, "asc"]],
            aoColumns: [
                { sType: 'integer', sName: 'Id', bSearchable: false, bSortable: false, sWidth: "60px" },
                { sType: 'string', sName: 'ScoreTypeName', bSearchable: true, bSortable: false, sWidth: "150px" },
                { sType: 'string', sName: 'ScoreName', bSearchable: true, bSortable: false, sWidth: "150px" },
                { sType: 'string', sName: 'Description', bSearchable: true, bSortable: false, sWidth: "450px" },
                { sType: 'string', sName: 'Overview', bSearchable: convertTrueFalse, bSortable: false, sWidth: "350px" },
                { sType: 'string', sName: 'ShortOverview', bSearchable: false, bSortable: false,bVisible:false, sWidth: "0px" },
                { sType: 'string', sName: 'ScoreTypeCode', bSearchable: false, bSortable: false,bVisible:false, sWidth: "0px" },
                { sType: 'string', sName: 'VirtualTestCustomSubScoreID', bSearchable: false, bSortable: false,bVisible:false, sWidth: "0px" },
                { sType: 'string', sName: 'IsPredefinedList', bSearchable: false, bSortable: false,bVisible:false, sWidth: "0px" },
                { sType: 'string', sName: 'ShortScoreType', bSearchable: false, bSortable: false,bVisible:false, sWidth: "0px" },
                { sType: 'string', sName: 'IsAutoCalculation', bSearchable: false, bSortable: false,bVisible:false, sWidth: "0px" },
                { sType: 'string', sName: 'MaxScore', bSearchable: false, bSortable: false, bVisible: false, sWidth: "0px" },
                { sType: 'string', sName: 'VirtualTestCustomMetaDataID', bSearchable: false, bSortable: false, bVisible: false, sWidth: "0px" },
            ],
            fnRowCallback: function (nRow, aData) {
                var itemForCalculate = {
                    type: aData[6],
                    name: aData[2],
                    id: aData[0],
                    column: aData[9]
                }
                if(itemForCalculate.type == "PERCENT_SCORE" && aData[10] == "True") {
                    hasPercentScoreAutoOverall = true;
                }
                if(itemForCalculate.type == "RAW_SCORE" && aData[10] != "True") {
                    overallRawMaxScore = aData[11];
                }
                if(itemForCalculate.type == "RAW_SCORE" && aData[10] == "True") {
                    hasRawOverallAuto = true;
                }
                if(itemForCalculate.type == "RAW_SCORE" || itemForCalculate.type == "NUMERIC_CUSTOM_SCORE") {
                    if (aData[10] === 'True') {
                        overallCalculateDetail.push(buildItemForCalculateDetail(aData[6], aData[4]));
                    }
                    var isIncluded = false;
                    for(var i = 0; i < overalScoreColumnForCalculate.length; i++) {
                        if(overalScoreColumnForCalculate[i].column == itemForCalculate.column) {
                            isIncluded = true;
                            break;
                        }
                    }
                    if(isIncluded == false && aData[10] != "True") {
                        overalScoreColumnForCalculate.push(itemForCalculate);
                    }
                }
                $(nRow).children().addClass('handle');
                if (aData[4].indexOf('List value') != -1) {
                    aData[4] = aData[4].replace('<', '&lt;');
                    aData[5] = aData[5].replace('<', '&lt;');
                    aData[4] = aData[4].replace('&lt;/br>', '</br>');
                    aData[5] = aData[5].replace('&lt;/br>', '</br>');
                }

                $('td:eq(0)', nRow).html(setIconVisibilityOverallScore(aData[2], aData[1], aData[9]));
                $('td:eq(1)', nRow).html(truncateText($('td:eq(1)', nRow),aData[2],35));
                $('td:eq(1)', nRow).attr('name', aData[2]);
                $('td:eq(2)', nRow).html(truncateText($('td:eq(2)', nRow),aData[1],35));
                $('td:eq(3)', nRow).html(truncateText($('td:eq(3)', nRow),aData[3],85));
                $('td:eq(3)', nRow).addClass('word-break list-initial');
                $('td:eq(4)', nRow).html(showShortOverview($('td:eq(4)', nRow),aData[4],aData[5],aData[8],aData[2],aData[10]));
                $(nRow).attr('table-id', '@Model.VirtualTestCustomScoreId');
                $(nRow).attr('table-scoreid', '@Model.VirtualTestCustomScoreId');
                $(nRow).attr('virtualTestCustomMetaDataID', aData[12]);
            },
            fnPreDrawCallback: function (oSettings) {
                ShowBlock($('#dataTableOverallScore'), "Loading");
                var scoreNameOverall = 'Overall';
                listDisableScore = [];
                listDisableScore[scoreNameOverall] = [];
                overalScoreColumnForCalculate = [];
                var aData = oSettings.aoData;
                aData.forEach(function (rowData) {
                    var data = rowData._aData;
                    if (data[10] === "True") {
                        var overview = data[4].split(";");
                        var overallRelated = overview[1];

                         // Overall sum/average with others score columns in Overall
                        if (overallRelated) {
                            var overallRelatedArr = overallRelated.split("-");
                            var overallRelatedCols = overallRelatedArr[1];
                            if (overallRelatedCols) {
                                overallRelatedCols = overallRelatedCols.split(",");
                                listDisableScore[scoreNameOverall] = listDisableScore[scoreNameOverall].concat(overallRelatedCols);
                            }
                        }

                        listDisableScore[scoreNameOverall].push(data[9]);

                        if (data[2] === 'Percent') listDisableScore[scoreNameOverall].push("Raw");

                        // Overall sum/average with others score columns of others Subscore
                        for (var i = 2; i < overview.length; i++) {
                            var subscoreRelated = overview[i];
                            if (subscoreRelated) {
                                var subscoreRelatedArr = subscoreRelated.split("-");
                                var subscoreRelatedName = subscoreRelatedArr[0];
                                var subscoreRelatedCols = subscoreRelatedArr[1];
                                listDisableScore[subscoreRelatedName] = listDisableScore[subscoreRelatedName] || [];
                                if (subscoreRelatedCols) {
                                    subscoreRelatedCols = subscoreRelatedCols.split(",");
                                    listDisableScore[subscoreRelatedName] = uniqueArray(listDisableScore[subscoreRelatedName].concat(subscoreRelatedCols));
                                }
                            }
                        }
                    }
                });
                listDisableScore[scoreNameOverall] = uniqueArray(listDisableScore[scoreNameOverall]);
                return true;
            },
            fnDrawCallback: function() {
                //Reload related table
                if (listSubScoreNeedReload.length > 0) {
                    listSubScoreNeedReload.forEach(function (scoreId) {
                        $("#dataTableOverallScore_" + scoreId).dataTable().fnDraw();
                    });
                    listSubScoreNeedReload = [];
                }

                $('#dataTableOverallScore').unblock();
                // $('.with-tip').tip();
                $('#dataTableOverallScore_length').hide();
                $('#dataTableOverallScore_info').hide();
                $('#dataTableOverallScore_wrapper .block-footer').hide();
                $('#dataTableOverallScore').css('width', 'auto');
                var classEdit = '.EditOverallScore-' + @(Model.VirtualTestCustomScoreId);
                var classDelete = '.DeleteOverallScore-' + @(Model.VirtualTestCustomScoreId);
                // edit tooltip
                intialTooltip($(classEdit), 'Edit');
                // edit tooltip
                intialTooltip($(classDelete), 'Delete Score Type');
                var table = document.querySelector("#dataTableOverallScore");
                var empty = $(table).find('.dataTables_empty');
                if('@Model.HasAssociatedTestResult' == 'False' && '@Model.HasAssociatedAutoSave' == 'False') {
                    $("#dataTableOverallScore tbody").sortable({
                        connectWith: ".connectedSortable",
                        cancel: ".dataTables_empty, .disabled-drag",
                        helper: function (event, ui) {
                            var $clone = $(ui).clone();
                            $clone.css('position', 'absolute');
                            $clone.addClass('ui-sortable-helper');
                            return $clone.get(0);
                        },
                        start: function (event, ui) {
                            const width = $('.ui-sortable-placeholder').width();
                            $('.ui-sortable-helper').css('width', width + 'px');
                            $('.ui-sortable-helper').css('background-color', 'white');
                            $(".ui-sortable-placeholder").parents("table").find("thead th").each(function (index, el) {
                                $(`.ui-sortable-helper td:nth-child(${index + 1})`).css('flex-basis', el.clientWidth + 'px');
                            });
                        },
                        receive: function (event, ui) {
                            var $currentTarget = ui.item;
                            var $senderTableInstance = $(ui.sender);
                            var $targetTableInstance = $(this);
                            var isFromOverallTable = $senderTableInstance.parents("table").attr("table-type") === "overall";
                            var currentScoreType = $currentTarget.find("[class*=EditOverallScore]").attr("scoretype");
                            var scoreName = $currentTarget.find("[class*=EditOverallScore]").attr('name');
                            var scoreTypeName = $currentTarget.find("[class*=EditOverallScore]").attr('scoretypename');
                            function updateScoreData(nameReplace, typeReplace, isReplace) {
                                var arrayOverScore = [];
                                var scoreId = $currentTarget.attr('table-scoreid');
                                var name = $currentTarget.find("[class*=EditOverallScore]").attr('name');
                                var from = $currentTarget.attr('table-id');
                                var url = '@Url.Action("UpdateMetaDataRaw")';
                                $targetTableInstance.find(".dataTables_empty").parent('tr').remove();
                                $targetTableInstance.find('tr').each(function (index, item) {
                                    var scoreType = $(this).find("[class*=EditOverallScore]").attr('scoretype');
                                    var _scoreName = $(this).find("[class*=EditOverallScore]").attr('name');
                                    tdNameElement = $(item).children('td')[1];
                                    arrayOverScore.push({
                                        Name: $(tdNameElement).attr('name'),
                                        ScoreType: scoreType
                                    });
                                });
                                $.ajax({
                                    type: 'POST',
                                    url: url,
                                    contentType: 'application/json',
                                    data: JSON.stringify({
                                        scoreId: scoreId,
                                        name: encodeURIComponent(name),
                                        scoreTypeName: currentScoreType,
                                        from: from, // ID of score from
                                        to: parseInt($targetTableInstance.parents('table').attr('table-id')), // ID of score to
                                        scoreTypeTos: arrayOverScore,
                                        isFromScore: isFromOverallTable,
                                        isSubSub: false, // if move score from sub to sub => true
                                        isReplace: isReplace,
                                        nameReplace: nameReplace,
                                        scoreTypeNameReplace: typeReplace
                                    })
                                }).done(function (response) {
                                    if (!response.success) {
                                        CustomAlert(response.error);
                                    }
                                    $senderTableInstance.parents("table").dataTable().fnDraw(false);
                                    $targetTableInstance.parents("table").dataTable().fnDraw(false);
                                });
                            }
                            var nameCompare = $targetTableInstance.find("[class*='EditOverallScore-" + parseInt($targetTableInstance.parents('table').attr('table-id')) + "']").filter((idx, ele) => ele.name.toLowerCase() === scoreName.toLowerCase())
                            if (listDisableSub['SubscoreName_' + $senderTableInstance.parents('table').attr('table-id')] && listDisableSub['SubscoreName_' + $senderTableInstance.parents('table').attr('table-id')].includes(currentScoreType)) {
                                customConfirm('You cannot move this column; it is being used by a calculation. Remove the calculation first.', {
                                    minWidth: '500px',
                                    textLeft: true,
                                    buttons: [
                                        {
                                            label: 'OK',
                                            color: 'red',
                                            callback: function () {
                                                $senderTableInstance.sortable("cancel");
                                            }
                                        }
                                    ]
                                });
                            } else if (nameCompare != null && nameCompare.length > 0) {
                                if (listDisableScore['Overall'] && listDisableScore['Overall'].includes($(nameCompare[0]).attr('scoretype'))) {
                                    customConfirm('You cannot replace this column. It is being used by a calculation.', {
                                        minWidth: '500px',
                                        textLeft: true,
                                        buttons: [
                                            {
                                                label: 'OK',
                                                color: 'red',
                                                callback: function () {
                                                    $senderTableInstance.sortable("cancel");
                                                }
                                            }
                                        ]
                                    });
                                } else {
                                    var name = nameCompare.attr("name");
                                    var type = nameCompare.attr("scoretype");
                                    CustomConfirm({
                                        message: 'This score type already exists. Do you want to replace it?',
                                        textLeft: true,
                                        customClass: 'custom-popup',
                                        yes: function () {
                                            updateScoreData(name, type, true);
                                        },
                                        no: function () {
                                            $senderTableInstance.sortable("cancel");
                                        },
                                        yesMessage: "Replace",
                                        noMessage: "Cancel",
                                    });
                                }
                            } else if (($targetTableInstance.find("[class*='EditOverallScore-" + parseInt($targetTableInstance.parents('table').attr('table-id')) + "'][scoretypename='" + scoreTypeName + "']").length > 3)
                                && (currentScoreType.includes('CustomN_') || currentScoreType.includes('CustomA_'))) {
                                var message = 'You have created the maximum number of numeric custom score allowed (4). If you need to create more scores, you can set them up as new subscores.';
                                if (currentScoreType.includes('CustomA_')) {
                                    message = 'You have created the maximum number of text custom score allowed (4). If you need to create more scores, you can set them up as new subscores.';
                                }
                                customConfirm(message, {
                                    minWidth: '500px',
                                    textLeft: true,
                                    buttons: [
                                        {
                                            label: 'OK',
                                            color: 'red',
                                            callback: function () {
                                                $senderTableInstance.sortable("cancel");
                                            }
                                        }
                                    ]
                                });
                            } else {
                                updateScoreData(null, null, false);
                            }
                        },
                        update: function (event, ui) {
                            var elChange = ui.item.parents('table').find('tbody tr');
                            var idOverallScore = @Model.VirtualTestCustomScoreId;
                            var arrayOverScore = [];
                            var td = '';
                            var tdName = '';

                            var idDatatableSubCoreSource = $(this).parent().attr('table-id');
                            var idDatatableSubCoreDestination = $(ui.item).parent().parent().attr('table-id');

                            if (idDatatableSubCoreSource == idDatatableSubCoreDestination && $(ui.item).attr("table-id") === $(ui.item).parents("table").attr("table-id")) {
                                elChange.each(function(index ,item) {
                                    td =  $(item).children('td')[0];
                                    tdName = $(item).children('td')[1];
                                    arrayOverScore.push({
                                        Name: $(tdName).attr('name'),
                                        ScoreType: $(td).children('.EditOverallScore-@(Model.VirtualTestCustomScoreId)').attr('scoretype')
                                    });
                                });
                                var url = '@Url.Action("UpdateMetaDataOrder")';
                                $.ajax({
                                    type: 'POST',
                                    url: url,
                                    contentType: 'application/json',
                                    data: JSON.stringify({scoreId: idOverallScore, scoreTypes: arrayOverScore})
                                });
                            }
                        }
                    });
                }
            }
        };

        $("#dataTableOverallScore").data("options", options);
        oTableOverallScore = $('#dataTableOverallScore').dataTable();
        oTableOverallScore.fnSetFilteringDelay(500); //TuanVo: delay searching when user type in search box to save time of query
        function setIconVisibilityOverallScore(name, scoreTypeName, scoreType) {
            //itemName = htmlEncode(itemName);
            var editIcon = '@Url.Content("~/Content/themes/Constellation/images/icons/fugue/pencil.png")';
            var editString = '<a href="javascript:void(0)" class="EditOverallScore-@(Model.VirtualTestCustomScoreId)" Name="' + encodeURIComponent(name) + '" ScoreTypeName="'+ scoreTypeName +'" scoreType="'+scoreType + '"><img src="' + editIcon + '" width="16" height="16" style="margin-right: 4px"></a>';

            var deleteIcon = '@Url.Content("~/Content/themes/Constellation/images/icons/fugue/cross-circle.png")';
            var deleteIconString = '<a href="javascript:void(0)" Name="' + encodeURIComponent(name) + '" ScoreTypeName="'+ scoreTypeName +'" scoreType="'+scoreType+'" class=" DeleteOverallScore" title="Delete"><img src="' + deleteIcon + '" width="16" height="16" style="margin-right: 0px"></a>';
            if ('@Model.HasAssociatedTestResult' == 'False' && '@Model.HasAssociatedAutoSave' == 'False') {
                return editString + deleteIconString;
            } else {
                return editString;//now allow to delete
            }

        }
        function truncateText(td,text, maxLength) {
            if (text == null) {
                text = '';
            }

            text = unescapeHtml(text);

            if (text.length > maxLength) {
                intialTooltip(td ,text);
                var limiText = '';
                limiText = text.substring(0, maxLength);
                return removeLastBRTag(limiText) + ' ...';

            } else {
                return text;
            }
        }
        function showShortOverview(td,overview,shortOverview,isPredefinedList,scoreName, isAutoCal) {
            overview = overview == null ? '' : overview;
            shortOverview = shortOverview == null ? '' : shortOverview;
            if (isAutoCal === 'True' && scoreName != 'Percent') {
                var arrOverview = overview.split(';');
                var type = arrOverview[0] == 'sum' ? "- Sum of columns: " : "- Average of columns: ";

                var textOverall = '';
                var overviewOverall = arrOverview[1].split('-');
                var overallHeader = overviewOverall[0];
                var overallColumns = overviewOverall[1].split(',');

                var arrOverallColumn = [];
                for (var o = 0; o < overallColumns.length; o++) {
                    arrOverallColumn.push(getColumnNameByColumnType(overallHeader, overallColumns[o]));
                }
                textOverall = '+ ' + overallHeader + ": " + arrOverallColumn.join(', ');

                var textSubscore = '';
                for (var i = 2; i < arrOverview.length; i++) {
                    var overviewSubscore = arrOverview[i].split('-');
                    var subscoreHeader = $('#'+overviewSubscore[0]).val();
                    var subscoreColumns = overviewSubscore[1].split(',');

                    var arrSubscoreColumn = [];
                    for (var s = 0; s < subscoreColumns.length; s++) {
                        arrSubscoreColumn.push(getColumnNameByColumnType(overviewSubscore[0], subscoreColumns[s]));
                    }
                    textSubscore += '+ ' + subscoreHeader + ": " + arrSubscoreColumn.join(', ') + '</br>';
                }
                overview = type + '</br>' + textOverall + '</br>' + textSubscore;

                shortOverview = overview.substring(0, 45);
                shortOverview += ' ...';

                overview = '';
                shortOverview = '';
            }
            if (isAutoCal === 'True' && scoreName == 'Percent') {
                overview = '';
                shortOverview = '';
            }
            if ((isPredefinedList != undefined && isPredefinedList == 'True') || scoreName == 'Artifact' || shortOverview.indexOf('List value') != -1) {
                // limit the  overview to make the shortOverview
                var arrStr = overview.split("</br>");
                var count = 0;
                var limitChar = 45;
                var arrResult = [];
                arrStr.forEach(text => {
                    if (count < limitChar) {
                        if ((count + text.length) > limitChar) {
                            arrResult.push(text.substring(0, (limitChar - count)) + '...');
                        } else {
                            arrResult.push(text);
                        }
                    }
                    count += text.length;
                })
                shortOverview = arrResult.join("</br>");
            }
            intialTooltip(td ,overview);
            return shortOverview;
        }
        function removeLastBRTag(input){
            // remove last </br> tag
            if(input != null)
            {
                input = input.trim();
                if(input.length >= 5 && input.substring(input.length - 5) == '</br>'){
                    input = input.substring(0, input.length - 5);
                }
            }

            return input;
        }

        function displayClassDetailTooltip(e, data, maxItemTooltipLength) {
            if (data == null) {
                data = '';
            }
            var width = '100px'; //default
            if (maxItemTooltipLength <= 50) {
                width = '200px';
            }
            else if (maxItemTooltipLength <= 100) {
                width = '300px';
            }
            else if (maxItemTooltipLength <= 150) {
                width = '450px';
            }
            else if (maxItemTooltipLength <= 200) {
                width = '600px';
            }
            else {
                width = '800px';
            }

          $(e).attr('title', '<p style="text-align:left;width:' + width + ';white-space: normal;word-break: break-all">' + data.split('|').join('<br />') + '</p>');
        }
        $('.DeleteOverallScore').live('click', function ()
        {
            var name = $(this).attr('Name');//Name as the key
            var scoreTypeName = $(this).attr('scoretypename');
            var scoreType = $(this).attr('scoretype');

            var canDelete = true;
            for (var i = 0; i < overallCalculateDetail.length; i++) {
                var overallCalculateDetailItem = overallCalculateDetail[i];
                for( var j = 0; j < overallCalculateDetailItem.overViewArray[0].includedColumns.length; j++) {
                    var item = overallCalculateDetailItem.overViewArray[0].includedColumns[j];
                    if (scoreType == item) {
                        canDelete = false;
                        break;
                    }
                }
            }
            if(canDelete == false) {
                customAlertMessage({message: 'You cannot delete this column; it is being used by a calculation. Remove the calculation first.'});
                return;
            }

            if(hasPercentScoreAutoOverall && scoreType == 'Raw') {
                customAlertMessage({message: 'You cannot delete this column; it is being used by a calculation. Remove the calculation first.'});
                return;
            }

            LoadConfirmDeleteOverallScore(name, scoreTypeName, scoreType);
        });

        $('.EditOverallScore-@(Model.VirtualTestCustomScoreId)').live('click', function () {
            var name = $(this).attr('Name');//name is used as identifier
            var scoreTypeName = $(this).attr('scoretypename');
            LoadEditScoreType(name, scoreTypeName);
        });

        var isOpenAddNewOverallScore = false;
        $('.CreateOverallScore').live('click', function () {
            var url = '@Url.Action("LoadCreateOverallScore")?templateId=@Model.VirtualTestCustomScoreId';
            if (isOpenAddNewOverallScore == true) {
                return;
            }
            isOpenAddNewOverallScore = true;
            $.ajax(
                {
                    url: url,
                    cache: false
                })
                .done(function(html) {
                    $("#divOverallScoreContainer").append('<div id="PopupCreateOverallScore" class="dialog"></div>');
                    $("#PopupCreateOverallScore").append(html);
                    $('#PopupCreateOverallScore').dialog({
                        title: "",
                        open: function() {
                            //Create overlay for popup
                            $("body").append('<div class="my-overlay" style="z-index: ' + ($.ui.dialog.currentZ() - 1) + ';width:' + $(document).width() + 'px;height:' + $(document).height() + 'px;background-color: black;opacity: 0.3;position: absolute;top:0px;left: 0px;"></div>');
                        },
                        beforeclose: function() {
                            return true;
                        },
                        close: function() {
                            $('#dataTableOverallScore').dataTable().fnDraw(false);
                            $('#PopupCreateOverallScore').remove();
                            $("body .my-overlay").remove();
                            isOpenAddNewOverallScore = false;
                        },
                        modal: false,
                        width: 500,
                        resizable: false
                    });
                });

            $(".close").unbind("click");
            $(".close").live("click", function(e) {
                e.preventDefault();
            });
        });

    });

    function LoadConfirmDeleteOverallScore(name, scoreTypeName, scoreType) {
        name = decodeURIComponent(name);
        CustomConfirm({
            message: 'Are you sure you want to DELETE ' + name + '?',
            textLeft: true,
            yes: function () {
                ShowBlock($('#dataTableOverallScore'), "Deleting");
                $.post('@Url.Action("DeleteScoreType")',
                    { templateId: @Model.VirtualTestCustomScoreId,
                        name:encodeURIComponent(name),
                        scoreTypeName: scoreTypeName
                    }
                    , function (response) {
                    $('#dataTableOverallScore').unblock();
                    if (response.success == true) {
                        customAlertMessage({message: 'Score type has been deleted.'});
                        $('#dataTableOverallScore').dataTable().fnDraw(false);
                        overalScoreColumnForCalculate = [];
                        overallCalculateDetail = [];
                        hasPercentScoreAutoOverall = false;
                        overallRawMaxScore = null;
                        hasRawOverallAuto = false;
                        updateOverallScoreList(false, scoreType, name);
                    } else {
                        customAlertMessage({message: response.error});
                    }
                });
            },
            no: function () {
            },
            open: function () {
            },
            close: function () {
            }
        });
    }

    function getAjaxSourceScoreTypeList() {
        return '@Url.Action("LoadScoreTypeList")?templateId=@Model.VirtualTestCustomScoreId';
    }

    function LoadEditScoreType(name, scoreTypeName) {
        ShowBlock($('#dataTableOverallScore'), "Loading");
        var url = '@Url.Action("LoadEditOverallScore")?templateId=@Model.VirtualTestCustomScoreId' + '&name=' + encodeURIComponent(name) + '&scoreTypeName=' + scoreTypeName;
        $.ajax(
            {
                url: url,
                cache: false
            })
            .done(function (html) {
                $("#divOverallScoreContainer").append('<div id="PopupEditOverallScore" class="dialog"></div>');
                $("#PopupEditOverallScore").append(html);
                $('#PopupEditOverallScore').dialog({
                    title: "",
                    open: function () {
                        //Create overlay for popup
                        $("body").append('<div class="my-overlay" style="z-index: ' + ($.ui.dialog.currentZ() - 1) + ';width:' + $(document).width() + 'px;height:' + $(document).height() + 'px;background-color: black;opacity: 0.3;position: absolute;top:0px;left: 0px;"></div>');
                    },
                    beforeclose: function () {
                        return true;
                    },
                    close: function () {
                        $('#PopupEditOverallScore').remove();
                        $('#dataTableOverallScore').dataTable().fnDraw(false);
                        $("body .my-overlay").remove();
                    },
                    modal: false,
                    width: 500,
                    resizable: false
                });

            });

        $(".close").unbind("click");
        $(".close").live("click", function (e) {
            e.preventDefault();
        });
    }


    function cancelOverallScore() {
        $(".dialog").dialog("close");
    }


    function showModalDialogBG() {
        var win = $('body');
        $('body').prepend('<div class="ui-widget-overlay" style="width: ' + win.width() + 'px; height: ' + win.height() + 'px; z-index: 1001;"></div>');
    }

    function getColumnNameByColumnType(parentType, scoreType) {
        if(parentType == 'Overall') {
            for(var i = 0; i < overalScoreColumnForCalculate.length; i++) {
                if(overalScoreColumnForCalculate[i].column == scoreType) {
                    return overalScoreColumnForCalculate[i].name;
                }
            }
        }
        return scoreType;
    }

    function intialTooltip(td ,text) {
        $(td).qtip({
            overwrite: false,
            content: {
                text: text
            },
            position: {
                my: 'bottom center',
                at: 'top center'
            },
            show: {
                event: 'mouseover'
            },
            hide: {
                event: 'mouseout'
            },
            hide: {
                fixed: true,
                delay: 100
            },
            events: {
                show: function () {
                var maxHeight = 0;
                $(td).offset().top > 400 ?  maxHeight = 400 : maxHeight =  $(td).offset().top ;
                var marginTop = 20;
                if($(this).height() > maxHeight) {
                    $(this).addClass('custom-top');
                    $(this).children('.qtip-content').css({
                        'max-height': maxHeight - marginTop + 'px'
                    });
                    }
                }
            }
        });
    }

    function buildItemForCalculateDetail(scoreType, overview) {
        var result = {
            scoreType: scoreType,
            overViewArray: []
        };

        var arrOverview = overview.split(';');
        var overviewOverall = arrOverview[1].split('-');

        var itemOverall = {
            parentType: overviewOverall[0],
            includedColumns: overviewOverall[1].split(',')
        };
        result.overViewArray.push(itemOverall);

        for (var i = 2; i < arrOverview.length; i++) {
            var overviewSubscore = arrOverview[i].split('-');

            var itemSubscore = {
                parentType: overviewSubscore[0],
                includedColumns: overviewSubscore[1].split(',')
            };
            result.overViewArray.push(itemSubscore);
        }
        return result;
    }
    function updateOverallScoreList(isAddNewScore, scoreType, name) {
        var urlUpdate = '@Url.Action("UpdateMetaDataOrder")';
        var arrayOverScore = [];
        var tr = $('#dataTableOverallScore tbody').children('tr');
        var tdName = '';
        var td = '';
        var idOverallScore = @Model.VirtualTestCustomScoreId;
         tr.each(function(index, element) {
            tdName = $(element).children('td')[1];
            td = $(element).children('td')[0];
            var st = $(td).children('.EditOverallScore-@(Model.VirtualTestCustomScoreId)').attr('scoretype');

            if (((!isAddNewScore && st != scoreType) || isAddNewScore) && !!st) {
                arrayOverScore.push({
                    Name: $(tdName).attr('name'),
                    ScoreType: st
                });
            }
        });
        if (isAddNewScore) {
            arrayOverScore.push({ Name: name, ScoreType: scoreType });
        }
        $.ajax({
            type: 'POST',
            url: urlUpdate,
            contentType: 'application/json',
            data: JSON.stringify({scoreId: idOverallScore, scoreTypes: arrayOverScore})
        }).done(function(response) {
            console.log(response);
        });
    }

    function updateSubScore(subScoreId, isAddNewScore, scoreType, name) {
        var urlUpdate = '@Url.Action("UpdateMetaDataOrder")';
        var arrayOverScore = [];
        var tr = $('#dataTableOverallScore_' + subScoreId + '_wrapper tbody').children('tr');
        var tdName = '';
        var tdType = '';
        var idOverallScore = @Model.VirtualTestCustomScoreId;
        var idDatatableSubCore = subScoreId;
        tr.each(function(index, element) {
            tdName = $(element).children('td')[1];
            tdType = $(element).children('td')[0];
            var st = $(tdType).children('.EditOverallScore-' + subScoreId).attr('scoretype');
            if ((isAddNewScore || (!isAddNewScore && st != scoreType)) && !!st)
            {
                arrayOverScore.push({
                    Name: $(tdName).attr('name'),
                    ScoreType:st
                });
            }
        });
        if (isAddNewScore) {
            arrayOverScore.push({ Name: name, ScoreType: scoreType });
        }
        $.ajax({
            type: 'POST',
            url: urlUpdate,
            contentType: 'application/json',
            data: JSON.stringify({scoreId: idOverallScore, subScoreId: idDatatableSubCore, scoreTypes: arrayOverScore})
        }).done(function(response) {
            console.log(response);
        });
    }
    function uniqueArray(arrArg) {
        return arrArg.filter(function (elem, pos, arr) {
            return arr.indexOf(elem) == pos;
        });
    }
</script>
