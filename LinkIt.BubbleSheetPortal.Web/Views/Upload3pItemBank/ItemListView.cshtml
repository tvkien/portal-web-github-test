@{
    ViewBag.Title = "Item List View";
}
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@*@MvcHtmlString.Create(
            Bundle.Css()
                        .Add(@Url.Content("~/Content/themes/TestMaker/ckeditor_mk.css"))
                        .Add(@Url.Content("~/Content/themes/TestMaker/contents.css"))
                        .Add(@Url.Content("~/Content/themes/base/jquery.ui.autocomplete.css"))
                .Render("/Content/themes/Constellation/css/test_maker_#.css")
             )*@
@LinkIt.BubbleSheetPortal.Web.Helpers.BundleHelper.StyleUpload3pItemBundle();
<script type="text/ecmascript">
    if ($.browser.msie  && parseInt($.browser.version, 10) == 9) {
        $("body").addClass("ie9");
    }
</script>


<script type="text/javascript" src="/Content/themes/TestMaker/ckeditor.js"></script>
<script type="text/javascript" src="/Content/themes/TestMaker/ckeditor_utils.js"></script>
<script type="text/javascript" src="/Content/themes/TestMaker/ckeditor_mk.js"></script>
<script type="text/javascript" src="https://s3-us-west-2.amazonaws.com/linkit-utility/MathJax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/javascript" src="@Url.Content("~/Scripts/qtiItemLoadMedia.js")"></script>

@*@MvcHtmlString.Create(
    Bundle.JavaScript()
    .Add("/Scripts/knockout-3.0.0.js")
                .Add("/Content/themes/TestMaker/mediaelement-and-player.min.js")
        .Render("/Content/themes/Constellation/js/test_maker_combined_#.js")
    )
@MvcHtmlString.Create(
            Bundle.Css()
                .Add(@Url.Content("~/Content/themes/AssessmentItem/css/popup.css"))
                    .Add(@Url.Content("~/Content/themes/LinkitStyleSheet.css"))
                        .Add(@Url.Content("~/Content/themes/Print/ItemSets/ItemSet.css"))
                    .Render("/Content/themes/Constellation/css/assessment_item_index_combined_#.css")
             )


@MvcHtmlString.Create(
    Bundle.JavaScript()
                .Add("/Scripts/imagesloaded.pkgd.js")
                .Add("/Scripts/PrintTest/PrintTest.js")
            .Render("/Content/themes/Constellation/js/qtiitem_combined_#.js")
    )*@

@LinkIt.BubbleSheetPortal.Web.Helpers.BundleHelper.StyleUpload3pItemBundle2()
@LinkIt.BubbleSheetPortal.Web.Helpers.BundleHelper.ScriptUpload3pItemBankBundle()
@LinkIt.BubbleSheetPortal.Web.Helpers.BundleHelper.ScriptUpload3pItemBankBundle2()

<style type="text/css">
    tr.even.row_selected td {
        background-color: #82CAFA !important;
    }

    tr.odd.row_selected td {
        background-color: #82CAFA !important;
    }

    #qti3pItemDataTable tbody input[type="checkbox"] {
        margin: 0;
        padding: 0;
        vertical-align: middle;
    }

    #qti3pItemDataTable p {
        line-height: 20px;
    }

    sourceObject {
        border: 1px solid #bebebe;
        background-color: #eeeeee;
        cursor: pointer;
        display: inline-block;
        min-width: 30px;
        min-height: 20px;
    }

        sourceObject[type=text] {
            padding: 0 0 2px 1px;
            margin: 2px 0px;
            background-color: #eeeeee;
            border: 1px solid #0088cc;
            color: #1c94c4;
            font-weight: bold;
            overflow: hidden;
            max-width: 600px;
        }

    destinationObject {
        display: inline-block;
        position: relative;
    }

        destinationObject[type=text] {
            border-radius: 6px;
            border: solid 1px #bebebe;
            padding: 2px;
            display: inline-block;
            font-style: italic;
            min-width: 50px;
            min-height: 20px;
            color: #ccc;
            margin: 2px 0px;
        }

    .questionItem {
        max-height: 60px;
        overflow: hidden;
        max-width: 700px;
        line-height: 1.57143em;
        font-size: 14px;
        font-family: "Lucida Grande", "Lucida Sans Unicode", Arial, sans-serif, dejavu_sansbook;
    }

    .img-action {
        margin-right: 4px;
        cursor: pointer;
        width: 32px;
        height: 32px;
        padding-top: 10px;
    }

    .qtiItemSelector select {
        min-width: 300px;
        max-width: 300px;
    }

    #uploadListDataTable_wrapper .answer {
        font-family: "Lucida Grande", "Lucida Sans Unicode", Arial, sans-serif, dejavu_sansbook;
        font-size: 14px;
        color: #333333;
    }

    .drawTool {
        display: none;
    }

    #uploadListDataTable_wrapper .normalText {
        font-size: 14px;
    }

    h1 {
        line-height: 19.8px !important;
    }

    .imageHotspotInteraction {
        border: 1px solid #ccc;
        position: relative;
    }

        .imageHotspotInteraction:hover,
        .imageHotspotInteraction:focus {
            border: 1px solid #ccc;
        }

        .imageHotspotInteraction img {
            max-width: none;
        }

        .imageHotspotInteraction .hotspot-item-type {
            cursor: default;
            pointer-events: none;
        }

    .hotspot-item-type {
        background: rgba(222, 222, 222, .5);
        color: #3c2f2f;
        border: 2px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        text-align: center;
        position: absolute;
        z-index: 5;
    }

        .hotspot-item-type:before {
            content: "";
            border: 1px solid #3c2f2f;
            display: inline-block;
            width: 80%;
            height: 80%;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            transform: translate(-50%, -50%);
            -ms-transform: translate(-50%, -50%);
            -webkit-transform: translate(-50%, -50%);
            position: absolute;
            top: 50%;
            left: 50%;
            visibility: hidden;
        }

        .hotspot-item-type[data-type="number"].checked,
        .hotspot-item-type[data-type="number"][data-correct="true"] .hotspot-item-value,
        .hotspot-item-type[data-type="number"][data-correct="false"]:not([data-point="0"]) .hotspot-item-value,
        .hotspot-item-type[data-type="letter"].checked,
        .hotspot-item-type[data-type="letter"][data-correct="true"] .hotspot-item-value,
        .hotspot-item-type[data-type="letter"][data-correct="false"]:not([data-point="0"]) .hotspot-item-value {
            font-weight: 900;
            color: #fff;
        }

            .hotspot-item-type[data-type="number"].checked:before,
            .hotspot-item-type[data-type="number"][data-correct="true"]:before,
            .hotspot-item-type[data-type="number"][data-correct="false"]:not([data-point="0"]):before,
            .hotspot-item-type[data-type="letter"].checked:before,
            .hotspot-item-type[data-type="letter"][data-correct="true"]:before,
            .hotspot-item-type[data-type="letter"][data-correct="false"]:not([data-point="0"]):before {
                background: #3c2f2f;
                border-radius: 100%;
                visibility: visible;
            }

        .hotspot-item-type[data-type="checkbox"]:before,
        .hotspot-item-type[data-type="circle"]:before {
            visibility: visible;
        }

        .hotspot-item-type[data-type="checkbox"].checked:after,
        .hotspot-item-type[data-type="checkbox"][data-correct="true"]:after,
        .hotspot-item-type[data-type="checkbox"][data-correct="false"]:not([data-point="0"]):after {
            visibility: visible;
            z-index: 10;
        }

        .hotspot-item-type[data-type="checkbox"].checked:before,
        .hotspot-item-type[data-type="checkbox"][data-correct="true"]:before,
        .hotspot-item-type[data-type="checkbox"][data-correct="false"]:not([data-point="0"]):before,
        .hotspot-item-type[data-type="circle"].checked:before,
        .hotspot-item-type[data-type="circle"][data-correct="true"]:before,
        .hotspot-item-type[data-type="circle"][data-correct="false"]:not([data-point="0"]):before {
            background: #3c2f2f;
            visibility: visible;
        }

        .hotspot-item-type[data-type="checkbox"]:after {
            content: '';
            display: inline-block;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            -webkit-transform: translate(-50%, -50%);
            -ms-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
            position: absolute;
            top: 50%;
            left: 50%;
        }

        .hotspot-item-type[data-type="checkbox"]:after {
            border: 5px solid #fcfff4;
            border-top: none;
            border-right: none;
            width: 50%;
            height: 30%;
            margin-top: -3px;
            visibility: hidden;
            -webkit-transform: rotate(-45deg) translate(-50%, -50%);
            -ms-transform: rotate(-45deg) translate(-50%, -50%);
            transform: rotate(-45deg) translate(-50%, -50%);
            -webkit-transform-origin: 0 0;
            -ms-transform-origin: 0 0;
            transform-origin: 0 0;
        }

    .hotspot-item-value {
        position: absolute;
        top: 50%;
        left: 50%;
        -webkit-transform: translate(-50%, -50%);
        -ms-transform: translate(-50%, -50%);
        transform: translate(-50%, -50%);
        cursor: default;
        pointer-events: none;
    }

    .hotspot-item-type[data-type="circle"]:before {
        border-radius: 100%;
    }

    .hotspot-item-type[data-type="circle"] .hotspot-item-value {
        width: 100%;
    }

        .hotspot-item-type[data-type="circle"] .hotspot-item-value:before,
        .hotspot-item-type[data-type="circle"] .hotspot-item-value:after {
            content: '';
            background: #fcfff4;
            width: 50%;
            height: 5px;
            visibility: hidden;
            position: absolute;
            top: 50%;
            left: 50%;
            -webkit-transform-origin: 0 0;
            -ms-transform-origin: 0 0;
            transform-origin: 0 0;
        }

        .hotspot-item-type[data-type="circle"] .hotspot-item-value:before {
            -webkit-transform: rotate(-45deg) translate(-50%, -50%);
            -ms-transform: rotate(-45deg) translate(-50%, -50%);
            transform: rotate(-45deg) translate(-50%, -50%);
        }

        .hotspot-item-type[data-type="circle"] .hotspot-item-value:after {
            -webkit-transform: rotate(45deg) translate(-50%, -50%);
            -ms-transform: rotate(45deg) translate(-50%, -50%);
            transform: rotate(45deg) translate(-50%, -50%);
        }

    .hotspot-item-type[data-type="circle"].checked .hotspot-item-value:before,
    .hotspot-item-type[data-type="circle"].checked .hotspot-item-value:after,
    .hotspot-item-type[data-type="circle"][data-correct="true"] .hotspot-item-value:before,
    .hotspot-item-type[data-type="circle"][data-correct="true"] .hotspot-item-value:after,
    .hotspot-item-type[data-type="circle"][data-correct="false"]:not([data-point="0"]) .hotspot-item-value:before,
    .hotspot-item-type[data-type="circle"][data-correct="false"]:not([data-point="0"]) .hotspot-item-value:after {
        visibility: visible;
    }

    .numberline-preview {
        position: relative;
        display: inline-block;
    }

    .numberline-hotspot {
        box-sizing: border-box;
        -moz-box-sizing: border-box;
        -webkit-box-sizing: border-box;
        background: #c7f1d5;
        display: inline-block;
        border: 2px solid #88b088;
        width: 12px;
        height: 12px;
        position: absolute;
        border-radius: 100%;
    }

        .numberline-hotspot[data-correct="true"],
        .numberline-hotspot[data-correct="false"]:not([data-point="0"]) {
            border: 2px solid darkgreen;
            background: #6bc287 !important;
        }

    .uploadify-button {
        background-color: transparent;
        border: none;
        padding: 0;
    }

    .uploadify:hover .uploadify-button {
        background-color: transparent;
    }

    .uploadify-progress {
        display: none;
    }

    .fileName {
        display: none;
    }

    .cancel {
        display: none;
    }

    .uploadify-queue-item {
        display: none;
    }
</style>
<article class="container_12">
    <section class="grid_12">
        <div class="class-title">
            @if (ViewBag.FileName != null)
            { @ViewBag.FileName}
        </div>
        <div class="block-border">
            <div class="block-content form" id="divQtiiTemListView">
                <table id="qti3pItemDataTable" class="datatable table no-margin" width="100%">
                    <thead>
                        <tr>
                            <th scope="col" style="text-align: center;">
                                <span class="column-sort">
                                    <a href="javascript:void(0)" title="Sort Up" class="sort-up"></a>
                                    <a href="javascript:void(0)" title="Sort Down" class="sort-down"></a>
                                </span>
                                Question Order
                            </th>
                            <th scope="col" style="text-align: center;">
                                <span class="column-sort">
                                    <a href="javascript:void(0)" title="Sort Up" class="sort-up"></a>
                                    <a href="javascript:void(0)" title="Sort Down" class="sort-down"></a>
                                </span>
                                File Name
                            </th>
                            <th scope="col" style="text-align: center;">
                                <span class="column-sort">
                                    <a href="javascript:void(0)" title="Sort Up" class="sort-up"></a>
                                    <a href="javascript:void(0)" title="Sort Down" class="sort-down"></a>
                                </span>
                                Content
                            </th>
                            <th style="display: none"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="height: 60px;"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="clear-10"></div>
            <div style="width:100%;text-align:right;margin-left:auto;margin-right:auto;">                
                <button id="btnCancelQtiItem" type="button" class="grey" tabindex="18" style="margin-left: 0px;">Cancel</button>
            </div>
        </div>
    </section>
    </article>

    <script type="text/javascript">

        var oTableQtiItem;

        $(function () {
            $('.write').addClass('current');
            $('#Upload3pItemBank').addClass('current');

            LoadQTIItemsToTable();

            $('#qti3pItemDataTable tbody').click(function (event) {
                $(oTableQtiItem.fnSettings().aoData).each(function () {
                    $(this.nTr).removeClass('row_selected');
                });

            });

            $('button[data-dialog="close"]').die('click');
            $(document).on('click', 'button[data-dialog="close"]', function (e) {
                var self = $(e.target);
                self.closest('.dialog').dialog('close');
            });

            $('#btnCancelQtiItem').click(function () {
                var link = '/Upload3pItemBank';
                link = encodeURI(link);
                window.location.href = link;
            });

        });

        function LoadQTIItemsToTable() {

            var options = {
                bServerSide: true,
                bStateSave: false,
                bFilter: false,
                sServerMethod: "POST",
                bDestroy: true,
                bProcessing: false,
                sAjaxSource: '@Url.Action("GetQTI3pItems")',
                fnServerParams: function (aoData) {
                    aoData.push(
                        { name: "dataFileUploadLogId", value: '@ViewBag.DataFileUploadLogId' }
                    );
                },
                iDisplayLength: 10,
                aoColumns: [
                    { sType: 'string', sName: 'QuestionOrder', bSearchable: false, bSortable: false, sWidth: '55px' },
                    { sType: 'string', sName: 'ResourceFileName', bSearchable: false, bSortable: false, sWidth: '100px' },
                    { sType: 'string', sName: 'Content', bSearchable: false, bSortable: false },
                    { sType: 'integer', sName: 'QTI3pItemId', bSearchable: false, bSortable: false, bVisible: false }
                ],

                aaSorting: [[0, "asc"]],
                fnRowCallback: function (nRow, aData) {
                    $('td:eq(2)', nRow).html(DisplayQTIItemTile(aData[2]));
                    $('td:eq(2)', nRow).find("video").each(function () {
                        this.pause();
                    });
                    //$('td:eq(2)', nRow).attr('id', aData[1]);//Add attribute Id for column Item Bank as QTIItemID
                    $('td:eq(2)', nRow).attr("onclick", 'ShowQti3pItemDetail(' + aData[3] + ',1)');
                    $('td:eq(2)', nRow).addClass("cursor-pointer");
                    return nRow;
                },
                fnPreDrawCallback: function () {
                    //ShowBlock($('#qti3pItemDataTable'), 'Loading');
                    return true;
                },
                fnDrawCallback: function () {
                    $('#qti3pItemDataTable').unblock();
                    LoadImages('#qti3pItemDataTable');
                    MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
                    //fraction is broken in new line
                    $("#qti3pItemDataTable").find('span[class="math-tex"]').each(function (index, value) {
                        var span = $(value);
                        //add display:inline-block
                        span.css('display', 'inline-block');
                    });

                    $('partialsequence sourceitem').each(function () {
                        var sourceItem = $(this);
                        sourceItem.css({ 'width': sourceItem.attr('width'), 'height': sourceItem.attr('height') });
                    });

                    $('.ui-widget-overlay').remove();
                    loadContentImageHotSpot('#qti3pItemDataTable');
                    loadContentNumberLineHotspot('#qti3pItemDataTable');
                    loadContentDragAndDrop('#qti3pItemDataTable');
                    return true;
                },
            };
            $("#qti3pItemDataTable").data("options", options);
            initializeDataTable($("#qti3pItemDataTable"));

            oTableQtiItem = $('#qti3pItemDataTable').dataTable();
        }


        function CopyAttributes(from, to) {
            var attrs = from.prop("attributes");
            $.each(attrs, function (index, attribute) {
                to.attr(attribute.name, attribute.value);
            });
        }

        function DisplayQTIItemTile(xmlContent) {
            
            var title = '';
            xmlContent = correctInlineChoice(xmlContent);

            $(xmlContent).find('.itemBody, itemBody, itembody').each(function () {
                var itemBody = $(this);
                itemBody.find("videolinkit").replaceWith(function () {
                    return $('');
                });
                if ($(xmlContent).find("responsedeclaration").attr("partialgrading") == "1") {
                    itemBody.find("sourcetext").each(function () {
                        if ($(this).attr("pointvalue") > 0) {
                            $(this).addClass("marker-correct");
                        }
                    });
                } else {
                    $(xmlContent).find("correctResponse").each(function () {
                        var id = $(this).attr("identifier");
                        itemBody.find("sourcetext[identifier=\"" + id + "\"]").addClass("marker-correct");
                    });
                }

                title = itemBody.html();
            });

            //var divTitle = '<div style=" overflow:hidden;max-width:700px;max-height:70px;line-height: 20px;" onclick="showEditQtiItemPopupIndex(' + qtiItemID + ',1)">' + title + '</div>';///LNKT-5785
            var divTitle = '<div style=" overflow:hidden;max-width:700px;max-height:70px;line-height: 20px;">' + title + '</div>';///LNKT-5785

            return divTitle;
        }

        jQuery.fn.outerHTML = function (s) {
            return (s)
                ? this.before(s).remove()
                : jQuery("<p>").append(this.eq(0).clone()).html();
        };

        function displayClassDetailTooltip(e, data, maxItemTooltipLength) {
            if (data == null) {
                data = '';
            }
            var width = '100px'; //default
            if (maxItemTooltipLength <= 50) {
                width = '200px';
            }
            else if (maxItemTooltipLength <= 100) {
                width = '300px';
            }
            else if (maxItemTooltipLength <= 150) {
                width = '450px';
            }
            else if (maxItemTooltipLength <= 200) {
                width = '600px';
            }
            else {
                width = '800px';
            }

            $(e).attr('title', '<p style="text-align:left;width:' + width + ';white-space: normal;word-break: break-all">' + data.split('|').join('<br />') + '</p>');
        }
    </script>

    <script>
        var isShowQti3pItemDetail = false;
        function ShowQti3pItemDetail(qti3pItemId, showPassage) {
            //open dialog
            if (isShowQti3pItemDetail == true) return;
            isShowQti3pItemDetail = true;
            var worker = $('<div />');
            worker
                .addClass("dialog")
                .attr("id", "qti3pQuestionList")
                .appendTo("body")
                .load('@Url.Action("ShowEditQtiItemItem","ItemBank")\?qtiItemId=0' +  '&showPassage=1' + '&qti3pItemIdUploaded=' + qti3pItemId, function () {
                    worker.dialog({
                        title: $(this).attr("Standard"),
                        open: function () {
                            AdjustQtiItemDetail();//declared in _Qti3pItemDetail.cshtml

                            var qtiItemHTML = $('#divQtiItemDetail ').html();
                            qtiItemHTML = qtiItemHTML.replace(/<videolinkit/g, "<video").replace(/<\/videolinkit>/g, "</video>").replace(/<sourcelinkit /g, "<source ").replace(/<\/sourcelinkit>/g, "</source>");
                            $('#divQtiItemDetail ').html(qtiItemHTML);
                            loadContentImageHotSpot('#divQtiItemDetail ');
                            loadContentDragAndDrop('#divQtiItemDetail ');

                            $('#divQtiItemDetail ').find('video').trigger('play');

                            loadContentNumberLineHotspot('#divQtiItemDetail ');
                        },
                        close: function () {
                            $('.ui-widget-overlay:last').remove();
                            $(this).remove();
                            $('#tips').html('');
                            isShowQti3pItemDetail = false;
                        },
                        modal: false,
                        width: 480,
                        resizable: false
                    });
                });
            showModalDialogBG();
        }

        function showModalDialogBG() {
            var win = $('body');
            $('body').prepend('<div class="ui-widget-overlay" style="width: ' + win.width() + 'px; height: ' + win.height() + 'px; z-index: 1001;"></div>');
        }

        //Passage
        function showPassagePopup() {
            var selectedQtiItemIds = getSelectedQtiItemIds();
            $('#hdSelectedQtiItemIds').val(getSelectedQtiItemIdsForRemark());
            var worker = $('<div />');
            worker
                .addClass("dialog PassagePopUpDialogCSS")
                .attr("id", "addPassageDialog")
                .appendTo("body")
                .load('@Url.Action("ShowPassagePopupForManyQtiItem")\?selectedQtiItemId=' + selectedQtiItemIds, function () {
                    worker.dialog({
                        open: function () {
                            $('#tips').html('');
                        },
                        title: $(this).attr("Standard"),
                        close: function () {
                            $('.ui-widget-overlay').remove();//will be remove when table display completelly
                            $(this).remove();
                            $('#tips').html('');
                            //$('#chkAllQtiItem').removeAttr('checked');
                            //clearCheckAll();
                            //disableActionButton(true);
                            //reload qtiItem list
                            $('#qti3pItemDataTable').dataTable().fnDraw(false);
                        },
                        modal: false,
                        width: 1084,
                        resizable: false
                    });
                });
            showModalDialogBG();
        }

        function LoadImages(containerSelector) {           
            $(containerSelector).find("img").each(function () {
                var image = $(this);
                var imageUrl = image.attr("src");
                if (IsNullOrEmpty(imageUrl)) {
                    imageUrl = image.attr("source");
                }

                if (IsNullOrEmpty(imageUrl)) imageUrl = '@Url.Content("~/Content/images/emptybg.png")';

                var testItemMediaPath = $('#hidTestItemMediaPath').val();
                var isLoadImage = imageUrl.indexOf(testItemMediaPath) != -1;

                if (isLoadImage) imageUrl = imageUrl.replace(testItemMediaPath, '');

                if (imageUrl.charAt(0) == '/') imageUrl = imageUrl.substring(1);

                image.attr("source", '');
                image.attr("src", imageUrl);
                if (imageUrl.toLowerCase().indexOf("http") == 0) return;
                if (((imageUrl && imageUrl.toLowerCase().indexOf("itemset") >= 0) || isLoadImage)
                    && imageUrl.toLowerCase().indexOf("getviewreferenceimg") < 0) {
                    imageUrl = 'TestAssignmentRegrader/GetViewReferenceImg?imgPath=' + imageUrl;
                    imageUrl = imageUrl + "&timestamp=" + new Date().getTime();
                    image.attr("src", imageUrl);
                }
            });

            //ResizeImagesBaseOnPercent('#qti3pItemDataTable');
        }
        function IsNullOrEmpty(value) {
            return typeof (value) === "undefined" || value == null || $.trim(value) == '';
        }
    </script>
