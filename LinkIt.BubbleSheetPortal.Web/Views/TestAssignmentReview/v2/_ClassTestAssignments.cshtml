@using LinkIt.BubbleSheetPortal.Web.Helpers
<link rel="stylesheet" href="/Scripts/Qtip/jquery.qtip.css">
<link rel="stylesheet" href="/Content/css/vue-components/vue-modal.css">
<link href="@BundleHelper.Version("~/Content/css/v2/testPreferenceSettingArea.css")" rel="stylesheet" type="text/css" />
<link href="@BundleHelper.Version("~/Content/css/v2/testPreferenceSetting.css")" rel="stylesheet" />

<script type="text/javascript" src="https://s3-us-west-2.amazonaws.com/linkit-utility/MathJax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script src="@Url.Content("~/Scripts/tipped/tipped.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/Qtip/jquery.qtip.js")"></script>
<script src="@Url.Content("~/Scripts/constants.js")"></script>
<style>
    #portal-v2-containter .ui-dialog a.ui-dialog-titlebar-close.ui-corner-all {
        right: 2rem;
    }

    #portal-v2-containter .icon-green {
        color: var(--green2);
    }

    #portal-v2-containter .icon-red {
        color: var(--red);
    }

    #portal-v2-containter .last-child table .icon {
        font-size: 1.25rem;
    }

    #portal-v2-containter #classDataTable_wrapper table tbody tr .teacher-col-style {
        word-break: keep-all;
    }

    #portal-v2-containter #classDataTable_wrapper table tbody tr .class-name-col-style,
    #portal-v2-containter #classDataTable_wrapper table tbody tr .student-col-style,
    #portal-v2-containter #classDataTable_wrapper table tbody tr .test-col-style {
        word-break: break-word;
    }

    #portal-v2-containter .last-child table .btn-review-assignment {
        text-decoration: none;
    }

    #portal-v2-containter input[type=checkbox]:not(.form-check-input) {
        margin-right: 0 !important;
    }


    @@media (max-width: 1399px) and (min-width: 1200px) {
        #portal-v2-containter .table thead th, .table thead td {
            padding: 0.5em 0.5em !important;
        }

        #portal-v2-containter #classDataTable_wrapper table thead th.action-col-style {
            width: 110px !important;
        }

        #portal-v2-containter #classDataTable_wrapper table thead th.date-col-style {
            word-break: break-all;
            width: 155px !important;
        }

        #portal-v2-containter #classDataTable_wrapper table thead th.test-col-style {
            width: 200px !important;
        }

        #portal-v2-containter #classDataTable_wrapper table thead th.teacher-col-style {
            width: 130px !important;
            word-break: break-all;
        }

        #portal-v2-containter #classDataTable_wrapper table thead th.authentication-code-col-style {
            width: 120px !important;
        }

        #portal-v2-containter #classDataTable_wrapper table thead th.code-col-style {
            word-break: break-all;
        }

        #portal-v2-containter #classDataTable_wrapper table thead th.student-col-style {
            width: 80px !important;
        }
    }

    @@media (min-width: 1400px) {
        #portal-v2-containter #classDataTable_wrapper table thead th.date-col-style {
            width: 160px !important;
        }

        #portal-v2-containter #classDataTable_wrapper table thead th.status-col-style {
            width: 115px !important;
        }

        #portal-v2-containter #classDataTable_wrapper table thead th.action-col-style {
            width: 140px !important;
        }

        #portal-v2-containter #classDataTable_wrapper table thead th.teacher-col-style {
            width: 150px !important;
        }

        #portal-v2-containter #classDataTable_wrapper table thead th.authentication-code-col-style {
            width: 130px !important;
        }

        #portal-v2-containter #classDataTable_wrapper table thead th.code-col-style {
            width: 135px !important;
        }

        #portal-v2-containter #classDataTable_wrapper table thead th.student-col-style {
            width: 80px !important;
        }
    }

    @@media (min-width: 1600px) {
        #portal-v2-containter #classDataTable_wrapper table thead th.status-col-style {
            width: 80px !important;
        }

        #portal-v2-containter #classDataTable_wrapper table thead th.action-col-style {
            width: 100px !important;
        }

        #portal-v2-containter #classDataTable_wrapper table thead th.date-col-style {
            width: 120px !important;
        }

        #portal-v2-containter #classDataTable_wrapper table thead th.student-col-style {
            width: 110px !important;
        }

        #portal-v2-containter #classDataTable_wrapper table thead th.authentication-code-col-style {
            width: 110px !important;
        }
    }

    #portal-v2-containter table .icon-review-hide:after {
        color: var(--red) !important;
    }

    #portal-v2-containter table .icon-review-show:after {
        color: var(--green2) !important;
    }

    .icon-legend-hide,
    .icon-legend-show,
    .icon-legend-regenerate {
        background: none;
        position: relative;
        font-size: 1.25rem !important;
        width: 24px;
        height: 24px;
        display: inline-block;
        vertical-align: middle;
    }

    .icon-legend-hide:after {
        position: absolute;
        top: 0;
        left: 0;
        font-family: 'Font Awesome 6 Free';
        font-weight: 900;
        content: "\f070";
        color: var(--red) !important;
    }

    .icon-legend-show:after {
        position: absolute;
        top: 0;
        left: 0;
        font-family: 'Font Awesome 6 Free';
        font-weight: 900;
        content: "\f06e";
        color: var(--green2) !important;
    }

    .icon-legend-regenerate:after {
        position: absolute;
        top: 0;
        left: 0;
        font-family: 'Font Awesome 6 Free';
        font-weight: 900;
        content: "\f01e";
        color: var(--red) !important;
    }
</style>

<div class="block-border" id="divClassTestAssignments">
    <div class="form">
        <div class="row">
            <div style="visibility: hidden" id="formCheckDeactivate" class="form-check form-switch d-flex flex-row align-items-center ms-0 ps-0">
                <label class="form-check-label mb-0 deactivated-title" for="flexSwitchCheckDefault">Show Deactivated:</label>
                <span class="ms-1 me-3" id="spanClassActive">Off</span>
                <div id="btnActiveTestClassAssignment">
                    <input class="form-check-input" type="checkbox" id="flexSwitchCheckDefault">
                </div>
            </div>

            <div style="visibility: hidden" id="btnActions">
                <button v-on:click="showingDistributeModal = !showingDistributeModal "
                        v-bind:disabled="selectedTestClassAssignment.length == 0"
                        class="btn-action">
                    Actions
                </button>
            </div>
        </div>
        <div class="toggle" style="display: none;">
            <a href="javascript:void(0)" id="btnClassPendingReview" style="margin-top: 1px; margin-left: -11px;" class="on">
                Pending Review:
                <span id="spanClassPendingReview">On</span>
            </a>
            <button id="btnClassView" type="button" style="margin-left: -11px; float: left; display: none;">Go to Student View</button>
        </div>
        <div class="last-child">
            <table id="classDataTable" class="datatable table table-assignment " width="100%">
                <thead>
                    <tr>
                        <th scope="col" style="text-align: center;" class="col-check">
                            <input type="checkbox" id="chkAllTest" />
                        </th>
                        <th scope="col" class="black-cell col-action">Take Action</th>
                        <th scope="col" class="table-col-90" style="text-align: center;">
                            <span class="column-sort">
                                <a title="Sort Up" class="sort-up"></a>
                                <a title="Sort Down" class="sort-down"></a>
                            </span>
                            Assigned
                        </th>
                        <th scope="col" style="text-align: center;">
                            <span class="column-sort">
                                <a href="javascript:void(0)" title="Sort Up" class="sort-up"></a>
                                <a href="javascript:void(0)" title="Sort Down" class="sort-down"></a>
                            </span>
                            Test
                        </th>
                        <th scope="col" style="text-align: center;">
                            <span class="column-sort">
                                <a href="javascript:void(0)" title="Sort Up" class="sort-up"></a>
                                <a href="javascript:void(0)" title="Sort Down" class="sort-down"></a>
                            </span>
                            Teacher
                        </th>
                        <th scope="col" style="text-align: center;">
                            <span class="column-sort">
                                <a href="javascript:void(0)" title="Sort Up" class="sort-up"></a>
                                <a href="javascript:void(0)" title="Sort Down" class="sort-down"></a>
                            </span>
                            Class
                        </th>
                        <th scope="col" style="text-align: center;" class="header-col-tip" title="Not Started">
                            <span class="th-nowrap-md-default">
                                <span class="column-sort">
                                    <a href="javascript:void(0)" title="Sort Up" class="sort-up"></a>
                                    <a href="javascript:void(0)" title="Sort Down" class="sort-down"></a>
                                </span>
                                NS
                            </span>
                        </th>
                        <th scope="col" style="text-align: center;" class="header-col-tip" title="In Progress">
                            <span class="th-nowrap-md-default">
                                <span class="column-sort">
                                    <a href="javascript:void(0)" title="Sort Up" class="sort-up"></a>
                                    <a href="javascript:void(0)" title="Sort Down" class="sort-down"></a>
                                </span>
                                IP
                            </span>
                        </th>
                        <th scope="col" style="text-align: center;" class="header-col-tip" title="Pending Review">
                            <span class="th-nowrap-md-default">
                                <span class="column-sort">
                                    <a href="javascript:void(0)" title="Sort Up" class="sort-up"></a>
                                    <a href="javascript:void(0)" title="Sort Down" class="sort-down"></a>
                                </span>
                                PR
                            </span>
                        </th>
                        <th scope="col" style="text-align: center;" class="header-col-tip" title="Finished">
                            <span class="th-nowrap-md-default th-nowrap-md-default--25">
                                <span class="column-sort">
                                    <a href="javascript:void(0)" title="Sort Up" class="sort-up"></a>
                                    <a href="javascript:void(0)" title="Sort Down" class="sort-down"></a>
                                </span>
                                Fini
                            </span>
                        </th>
                        <th scope="col" style="text-align: center;" class="header-col-tip" title="Assignment Code">
                            <span class="column-sort">
                                <a href="javascript:void(0)" title="Sort Up" class="sort-up"></a>
                                <a href="javascript:void(0)" title="Sort Down" class="sort-down"></a>
                            </span>
                            Code
                        </th>
                        <th scope="col" style="text-align: center;" class="header-col-tip" title="Authentication Password">
                            <span class="column-sort">
                                <a href="javascript:void(0)" title="Sort Up" class="sort-up"></a>
                                <a href="javascript:void(0)" title="Sort Down" class="sort-down"></a>
                            </span>
                            Auth
                        </th>
                        <th scope="col" style="text-align: center">
                            <span class="column-sort">
                                <a href="javascript:void(0)" title="Sort Up" class="sort-up"></a>
                                <a href="javascript:void(0)" title="Sort Down" class="sort-down"></a>
                            </span>
                            Student
                        </th>
                        <th scope="col" style="display: none"></th>
                        <th scope="col" style="display: none"></th>
                        <th scope="col" style="display: none"></th>
                        <th scope="col" style="display: none"></th>
                        <th scope="col" style="display: none"></th>
                        <th scope="col" style="display: none"></th>
                        <th scope="col" style="display: none"></th>
                        <th scope="col" style="display: none"></th>
                        <th scope="col" style="display: none"></th>
                        <th scope="col" style="display: none"></th>
                        <th scope="col" style="display: none"></th>
                        <th scope="col" style="display: none"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="height: 60px;"></td>
                    </tr>

                </tbody>
            </table>
        </div>
    </div>
    <modal-component v-bind:show.sync="showingDistributeModal" v-bind:width="455" id="modal-distribute">
        <div slot="close"><span></span></div>
        <div slot="header">
            <div class="block-heading">
                <h1 class="block-heading-item is-active">ACTIONS</h1>
            </div>
        </div>
        <div slot="body" class="u-m-t-20">
            <p style="margin-bottom: 10px" class="action-input">
                <input type="radio" id="activate-test" name="action-types" v-model="actionMethods" value="activate-test" />
                <label for="activate-test"><b>Activate Test</b></label><br />
            </p>
            <p style="margin-bottom: 10px" class="action-input">
                <input type="radio" id="deactivate-test" name="action-types" v-model="actionMethods" value="deactivate-test" />
                <label for="deactivate-test"><b>Deactivate Test</b></label>
            </p>
            <p style="margin-bottom: 10px" id="pShow" class="action-input">
                <input type="radio" id="show-test" name="action-types" v-model="actionMethods" value="show-test" />
                <label for="show-test"><b>Show test in the Student Portal</b></label>
            </p>
            <p style="margin-bottom: 10px" id="pHide" class="action-input">
                <input type="radio" id="hide-test" name="action-types" v-model="actionMethods" value="hide-test" />
                <label for="hide-test"><b>Hide test in the Student Portal</b></label>
            </p>
            <p style="margin-bottom: 10px" class="action-input">
                <input type="radio" id="export-student-sessions" name="action-types" v-model="actionMethods" value="export-student-sessions" />
                <label for="export-student-sessions"><b>Export Student Sessions</b></label>
            </p>
            <p style="margin-bottom: 10px" class="action-input">
                <input type="radio" id="export-test-assignments" name="action-types" v-model="actionMethods" value="export-test-assignments" />
                <label for="export-test-assignments"><b>Export Test Assigments</b></label>
                <div style="margin-left:25px" v-show="checkedActivateTest">
                    You will change the status of <b>{{selectedTestClassAssignmentCount}}</b> assignment{{(selectedTestClassAssignmentCount > 1 ? 's' : '')}} to active.
                </div>
                <div style="margin-left:25px" v-show="checkedExportTestAssigments">
                    You selected <b>{{selectedTestClassAssignmentCount}}</b> assignment{{(selectedTestClassAssignmentCount > 1 ? 's' : '')}} to export test assignments
                </div>
                <div style="margin-left:25px" v-show="checkedExportStudentSessions">
                    You selected <b>{{selectedTestClassAssignmentCount}}</b> assignment{{(selectedTestClassAssignmentCount > 1 ? 's' : '')}} to export student sessions
                </div>
                <div style="margin-left:25px" v-show="checkedHideTest">
                    You will hide <b>{{selectedTestClassAssignmentCount}}</b> test{{(selectedTestClassAssignmentCount > 1 ? 's' : '')}} in the Student Portal
                </div>
                <div style="margin-left:25px" v-show="checkedShowTest">
                    You will show <b>{{selectedTestClassAssignmentCount}}</b> test{{(selectedTestClassAssignmentCount > 1 ? 's' : '')}} in the Student Portal.
                </div>
                <div style="margin-left:25px" v-show="checkedDeactivateTest">
                    You will change the status of <b>{{selectedTestClassAssignmentCount}}</b> assignment{{(selectedTestClassAssignmentCount > 1 ? 's' : '')}} to inactive.
                </div>
            </p>
        </div>
        <div slot="footer">
            <!-- <button id="btnSubmit" type="submit" v-on:click="submitDistribute" name="distribute">Submit</button> -->
            <button id="btnCancel" type="button" v-on:click="showingDistributeModal = false" class="grey">Cancel</button>
            <button id="btnSubmit" type="submit" v-on:click="showingDistributeModal = false" name="submit">Submit</button>
        </div>
    </modal-component>
    @Html.Partial("v2/_ModalActiveAndDeActiveClassAssignment")
</div>

<div class="block-border" id="dvTestAssignmentDefaultSettingPanel" style="position: static; display: none">
    <div class="block-content form bubbleSheetSelector">
        <fieldset class="grey-bg">
            <div class="header">Assignment Setting</div>
            <div id="dvTestAssignmentDefaultSetting"></div>
        </fieldset>
    </div>
</div>
<div id="divHideShowAssignment">
    @Html.Partial("v2/_ModalHideShowAssignment")
    @Html.Partial("v2/_ModalShowHideStudentSPP")
</div>
<input type="hidden" id="hdAssignmentCodes" value="@ViewBag.AssignmentCodes" />
<script type="text/javascript">

    function displayDateWithFormatFixBug(tickDateTime, displayHour) {
        if (tickDateTime == undefined || tickDateTime == null || tickDateTime == "") {
            return '';//default US
        }

        var defaultDateFormat = readCookie('DefaultDateFormat');
        var defaultTimeFormat = readCookie('DefaultTimeFormat');

        if (defaultDateFormat == null || defaultDateFormat == undefined) {
            defaultDateFormat = 'MM/dd/yyyy';//default value if defaultDateFormat is not provided
        }
        if (defaultTimeFormat == null || defaultTimeFormat == undefined) {
            defaultTimeFormat = 'h:mm tt';//default value if defaultTimeFormat is not provided
        }

        if (displayHour != undefined && displayHour) {
            defaultDateFormat = defaultDateFormat + ' ' + defaultTimeFormat;
        }


        var date = eval(tickDateTime.replace(/\/Date\((\d+)\)\//gi, "new Date($1)"));
        return date.toString(defaultDateFormat);
    }

</script>
<script type="text/javascript">
    var vueService = {
        changeHideShow: function (params) {
            return $.ajax({
                type: "POST",
                url: '/TestAssignmentReview/ChangeStatusShowHide',
                data: params
            });
        }
    };
    var vueModel = new Vue({
        el: '#divHideShowAssignment',
        data: {
            isShowModalHideShow: false,
            isHide: false,
            qtiTestassingmentId: 0,
            showingDistributeModal: false,
            //Group and class students
            isShowModalShowHideSPP: false,
            isShowListStudents: false,
            titleChangeShowHideSPP: '',
            studentList: [],
            studentListFilterShowHide: [],
            isHideOption: true,
            showAllStudents: true,
            hideAllStudents: true,
            showSelectedStudents: false,
            hideSelectedStudents: false,
            paramChangeShowHideSPP: {
                studentStr: '',
                type: 0
            },
            AssignmentType: 0
        },
        watch: {
            immediate: true, // Immediate option to call watch handler on first mount
            handler() {
                this.resetSelectedOptionStudent()
            }
        },
        computed: {
            visibleText: function () {
                return this.isHide ? 'show': 'hide';
            }
        },
        methods: {
            changeStatusHideShow: function () {
                this.isShowModalHideShow = false;
                this.isShowModalShowHideSPP = false;
                this.resetSelectedOptionStudent();
                $('.clssOptionStudent').prop("checked", false);
                $('.clssOptionStudent').val("");
                var students = [];
                if (vueModel.showAllStudents == true || vueModel.hideAllStudents == true) {
                    vueModel.studentList.forEach(function (student) {
                        students.push(parseFloat(student.StudentId));
                    });
                } else {
                    $(".student-item-show-hide[isSelected=yes]").each(function () {
                        students.push(parseFloat($(this).attr('studentId')));
                    });
                }                
                if (vueModel.showSelectedStudents == true || testAssignmentsModel.hideSelectedStudents == true) {
                    if (students.length === 0) {
                        $('.cls-show-hide-student').prop('disabled', true);
                    }
                    else {
                        $('.cls-show-hide-student').prop('disabled', false);
                    }
                }

                var params = {
                    qtiTestClassAssignmentID: this.qtiTestassingmentId,
                    isHide: this.isHide,
                    studentStr: students.join(','),
                    type: this.AssignmentType
                };
                ShowBlock($('#classDataTable'), 'Loading');
                vueService.changeHideShow(params).done(function () {
                    SetupFilters();
                }).error(function (err) {
                    console.log(err);
                });
            },
            closeModalHideShow: function () {
                this.isShowModalHideShow = false;
            },
            selectAllStudents: function () {
                if (this.studentListFilterShowHide && this.studentListFilterShowHide.length > 0) {
                    $('.cls-show-hide-student').prop('disabled', false);
                }
                $('.student-col').children().attr('isselected', "yes");
                $('.student-col').children().css('background-color', "#82CAFA");
                CheckValidToAssign();
            },
            selectNoStudents: function () {
                $('.cls-show-hide-student').prop('disabled', true);
                $('.student-col').children().attr('isselected', "no");
                $('.student-col').children().css('background-color', "#f2f2f2");
                CheckValidToAssign();
            },
            invertSelectedStudents: function () {
                $('.generate-student-list li').each(function () {
                    if ($(this).attr('isselected') == "yes") {
                        $('.cls-show-hide-student').prop('disabled', true);
                        $(this).attr('isselected', "no");
                        $(this).css('background-color', "#f2f2f2");
                    } else {
                        $('.cls-show-hide-student').prop('disabled', false);
                        $(this).attr('isselected', "yes");
                        $(this).css('background-color', "#82CAFA");
                    }
                });
                CheckValidToAssign();
            },
            chooseShowForAllStudent: function () {
                this.resetSelectedOptionStudent();
                this.showAllStudents = true;
                this.isShowListStudents = false;
                this.isHide = true;
                $('.cls-show-hide-student').prop('disabled', false);
            },
            chooseHideForAllStudent: function () {
                this.resetSelectedOptionStudent();
                this.hideAllStudents = true;
                this.isShowListStudents = false;
                this.isHide = false;
                $('.cls-show-hide-student').prop('disabled', false);
            },
            chooseHideSelectedStudent: function () {
                this.isHide = false;
                this.studentListFilterShowHide = this.studentList.filter(function (student) { return student.IsHide == false });
                this.resetSelectedOptionStudent();
                $('.cls-show-hide-student').prop('disabled', true);
                this.hideSelectedStudents = true;
                this.isShowListStudents = true;
                this.showAllStudents = false;
                this.hideAllStudents = false;
            },
            chooseShowSelectedStudent: function () {
                this.isHide = true;
                this.studentListFilterShowHide = this.studentList.filter(function (student) { return student.IsHide == true });
                this.resetSelectedOptionStudent();
                $('.cls-show-hide-student').prop('disabled', true);
                this.showSelectedStudents = true;
                this.isShowListStudents = true;
                this.showAllStudents = false;
                this.hideAllStudents = false;
            },
            resetSelectedOptionStudent: function () {
                $('.clssOptionStudent').removeClass('input-checked-v2');
            },
            changeCloseShowHideSPP: function () {
                this.isShowModalShowHideSPP = false;
                this.isShowListStudents = false;
            }
        }
    });

    var testAssignmentsModel = new Vue({
        el: '#divClassTestAssignments',
        data: {
            selectedTestClassAssignment: [],
            showingDistributeModal: false,
            actionMethods: 'activate-test',
            isShowModalActiveAndDeActive: false,
            isShowListStudents: false,
            titleChangeActive: '',
            studentList: [],
            studentListFilter: [],
            isShowActive: true,
            activeAllStudents: true,
            deActiveAllStudents: true,
            activeSelectedStudents: false,
            deActiveSelectedStudents: false,
            paramChangeActiveAndDeactive: {
                qTITestClassAssignmentID: null,
                operationType: null,
                testName: '',
                isRetakeAssignment: null,
                students: [],
                classId: 0,
                type: 0
            }
        },
        watch: {
            immediate: true, // Immediate option to call watch handler on first mount
            handler() {
                this.resetClassInputCheck();
            }
        },
        computed: {
            selectedTestClassAssignmentCount: function () {
                var countarr = [];
                var _self = this;
                switch (true) {
                    case _self.checkedActivateTest:
                        countarr = _self.selectedTestClassAssignment;
                        return countarr.length;
                    case _self.checkedDeactivateTest:
                        countarr = _self.selectedTestClassAssignment.filter(function (item) { return item.status === "1" })
                        return countarr.length;
                    case _self.checkedShowTest:
                        countarr = _self.selectedTestClassAssignment.filter(function (item) { return _self.isSubCondition(item) })
                        return countarr.length;
                    case _self.checkedHideTest:
                        countarr = _self.selectedTestClassAssignment.filter(function (item) { return item.ishide === 'false' && _self.isSubCondition(item) })
                        return countarr.length;
                    case _self.checkedExportStudentSessions:
                    case _self.checkedExportTestAssigments:
                        return _self.selectedTestClassAssignment.length;
                }
            },
            checkedActivateTest: function () {
                return this.actionMethods === 'activate-test';
            },
            checkedDeactivateTest: function () {
                return this.actionMethods === 'deactivate-test';
            },
            checkedShowTest: function () {
                return this.actionMethods === 'show-test';
            },
            checkedHideTest: function () {
                return this.actionMethods === 'hide-test';
            },
            checkedExportStudentSessions: function () {
                return this.actionMethods === 'export-student-sessions';
            },
            checkedExportTestAssigments: function () {
                return this.actionMethods === 'export-test-assignments';
            }
        },
        methods: {
            isSubCondition: function (item) {
                return item.status === '1' && IsShowUserCurrentDictrictStudentPortal && (item.isteacherled === 'false' || item.isteacherled === 'null')
            },
            updateSelectedTestClassAssignment: function () {
                var idlist = [];
                $("input.rcode:checked").each(function (index, elem) {
                    idlist.push({
                        qtitestclassassignmentid: $(elem).attr('data-qtitestclassassignmentid'),
                        status: $(elem).attr('data-status'),
                        ishide: $(elem).attr('data-ishide'),
                        isteacherled: $(elem).attr('data-isteacherled')
                    });

                    $(elem).closest('tr').addClass("row-selected");
                });

                $("input.rcode:not(:checked)").each(function (index, elem) {
                    $(elem).closest('tr').removeClass("row-selected");
                });

                this.selectedTestClassAssignment = idlist;
                if (testAssignmentsModel.selectedTestClassAssignment.length === 0) {
                    $('#btnActions').addClass("is-disabled");
                } else {
                    $('#btnActions').removeClass("is-disabled");
                }
            },

            resetSelectedTestClassAssignment: function () {
                $('#chkAllTest').prop("checked", false);

                this.selectedTestClassAssignment = [];

                if (testAssignmentsModel.selectedTestClassAssignment.length === 0) {
                    $('#btnActions').addClass("is-disabled");
                } else {
                    $('#btnActions').removeClass("is-disabled");
                }
            },

            submitfunction: function () {
                var operationOption = 1;
                var operationHide = true;
                var _self = this;
                if (_self.checkedActivateTest || _self.checkedDeactivateTest) {
                    operationOption = this.checkedActivateTest ? 0 : 1;
                    $("#messageClassDialog").dialog("close");
                    var qtiTestClassAssignmentIDs = operationOption ? _self.selectedTestClassAssignment.filter(function (item) {
                        return item.status === "1"
                    }) : _self.selectedTestClassAssignment;

                    $.post('@Url.Action("ChangeStatusMutipleAssignment")',
                        {
                            qtiTestClassAssignmentIDs: qtiTestClassAssignmentIDs.map(function (item) {
                                return item.qtitestclassassignmentid
                            }).join(','),
                            operationOption: operationOption
                        },
                        function (response) {
                            $('.clssOptionStudent').removeClass('input-checked-v2');
                            SetupFilters();
                            var testsNotActive = response.virtualTestNames;
                            if (testsNotActive != null && testsNotActive!= '') {
                                $(".blockUI").hide();
                                var strHtml = "";
                                for (var i = 0; i < testsNotActive.length; i++) {
                                    strHtml += "<li style='margin-left: 10px;width: 100%;text-align: left;'>" + testsNotActive[i] + "</li>";
                                }
                                popupAlertMessageV2('alert', '<nobr>Student(s) have an existing retake assignment or have already completed the test(s):</nobr>' + strHtml, 750, 500)
                            }

                        });
                } else if (_self.checkedShowTest || _self.checkedHideTest) {
                    (operationHide = _self.checkedShowTest);
                    $("#messageClassDialog").dialog("close");
                    var qtiTestClassAssignmentIDs = operationHide ? _self.selectedTestClassAssignment.filter(function (item) {
                        return _self.isSubCondition(item)
                    })
                        : _self.selectedTestClassAssignment.filter(function (item) {
                            return item.ishide + '' === "false" && _self.isSubCondition(item)
                        })
                    $.post('@Url.Action("ChangeStatusShowHideMutipleAssignment")',
                        {
                            qtiTestClassAssignmentIDs: qtiTestClassAssignmentIDs.map(function (item) {
                                return item.qtitestclassassignmentid
                            }).join(','),
                            isHide: operationHide
                        }, function (response) {
                            $('.clssOptionStudent').removeClass('input-checked-v2');
                            SetupFilters();
                        });
                } else if (_self.checkedExportStudentSessions) {
                    var url = '@Url.Action("ExportTestStudentSessions")';
                    ShowBlock($('#divClassTestAssignments'), "Exporting");
                    $.ajax({
                        url: url,
                        data: {
                            DateTime: $('#dateTime option:selected').val(),
                            DistrictID: $('#selectDistrict').val(),
                            QTITestClassAssignmentIDs: _self.selectedTestClassAssignment.map(function (item) {
                                return item.qtitestclassassignmentid
                            }).join(',')
                        },
                        cache: false
                    }).done(function (url) {
                        $('#divClassTestAssignments').unblock();
                        popupAlertExportInfoMessage('ui-popup-exportInfo', 350, 125, url);
                    });
                } else if (_self.checkedExportTestAssigments) {
                    var url = '@Url.Action("ExportTestAssignments")';
                    ShowBlock($('#divClassTestAssignments'), "Exporting");
                    $.ajax({
                        url: url,
                        data: {
                            DateTime: $('#dateTime option:selected').val(),
                            QTITestClassAssignmentIDs: _self.selectedTestClassAssignment.map(function (item) {
                                return item.qtitestclassassignmentid
                            }).join(','),
                            DistrictID: $('#selectDistrict').val()
                        },
                        cache: false
                    }).done(function (url) {
                        $('#divClassTestAssignments').unblock();
                        popupAlertExportInfoMessage('ui-popup-exportInfo', 350, 125, url);
                    });
                }
            },
            changeActiveAndDeActiveClassAssignment: function () {
                HandleClassOKClick(this.paramChangeActiveAndDeactive.qTITestClassAssignmentID, this.paramChangeActiveAndDeactive.operationType, this.paramChangeActiveAndDeactive.testName, this.paramChangeActiveAndDeactive.isRetakeAssignment, this.paramChangeActiveAndDeactive.type);
            },
            closeModalActiveAndDeActive: function () {
                this.isShowModalActiveAndDeActive = false;
                this.isShowListStudents = false;
            },
            selectAllStudents: function () {
                if (this.studentListFilter && this.studentListFilter.length > 0) {
                    $('.cls-assign-student').prop('disabled', false);
                }                
                $('.student-col').children().attr('isselected', "yes");
                $('.student-col').children().css('background-color', "#82CAFA");
                CheckValidToAssign();
            },
            selectNoStudents: function () {
                $('.cls-assign-student').prop('disabled', true);
                $('.student-col').children().attr('isselected', "no");
                $('.student-col').children().css('background-color', "#f2f2f2");
                CheckValidToAssign();
            },
            invertSelectedStudents: function () {
                $('.generate-student-list li').each(function () {
                    if ($(this).attr('isselected') == "yes") {
                        $('.cls-assign-student').prop('disabled', true);
                        $(this).attr('isselected', "no");
                        $(this).css('background-color', "#f2f2f2");
                    } else {
                        $('.cls-assign-student').prop('disabled', false);
                        $(this).attr('isselected', "yes");
                        $(this).css('background-color', "#82CAFA");
                    }
                });
                CheckValidToAssign();
            },
            chooseActiveForAllStudent: function () {
                this.resetClassInputCheck();
                this.activeAllStudents = true;
                $('.cls-assign-student').prop('disabled', false);
                this.paramChangeActiveAndDeactive.operationType = 0;
                this.isShowListStudents = false;
            },
            chooseDeactiveForAllStudent: function () {
                this.resetClassInputCheck();
                this.deActiveAllStudents = true;
                $('.cls-assign-student').prop('disabled', false);
                this.paramChangeActiveAndDeactive.operationType = 1;
                this.isShowListStudents = false;
            },
            chooseDeactiveSelectedStudent: function () {
                this.resetClassInputCheck();
                $('.cls-assign-student').prop('disabled', true);
                this.deActiveSelectedStudents = true;
                this.studentListFilter = this.studentList.filter(function (student) { return student.Status == 1 });
                this.paramChangeActiveAndDeactive.operationType = 1;
                this.isShowListStudents = true;
                this.activeAllStudents = false;
                this.deActiveAllStudents = false;
            },
            chooseActiveSelectedStudent: function () {
                this.resetClassInputCheck();
                $('.cls-assign-student').prop('disabled', true);
                this.activeSelectedStudents = true;
                this.studentListFilter = this.studentList.filter(function (student) { return student.Status == 0 });
                this.paramChangeActiveAndDeactive.operationType = 0;
                this.isShowListStudents = true;
                this.activeAllStudents = false;
                this.deActiveAllStudents = false;
            },
            resetClassInputCheck: function () {
                $('.clssOptionStudent').removeClass('input-checked-v2');
            },
        }
    });

    $(document).ready(function () {
        if (!IsShowUserCurrentDictrictStudentPortal) {
            $('#pHide').attr("hidden", true);
            $('#pShow').attr("hidden", true);
        }
     });

    $('#btnSubmit').click(function () {
        testAssignmentsModel.submitfunction();
    });

    function rcode_onchange(t, qtiTestClassAssignmentID) {
        var isAllSelected = true;
        testAssignmentsModel.updateSelectedTestClassAssignment();
        $("input.rcode").each(function (index, elem) {
            if (!$(elem).is(':checked')) {
                isAllSelected = false;
            }
        });
        $('#chkAllTest').prop("checked", isAllSelected);
    };

    $('#chkAllTest').click(function () {
        $("input.rcode").each(function (index, elem) {
            $(elem).prop("checked", $('#chkAllTest').is(':checked'));
            setCheckBoxClassV2Skin($('#chkAllTest').is(':checked'), elem)
        });
        testAssignmentsModel.updateSelectedTestClassAssignment();
    });


    var teacherReviewerPageLoad = true;
    $(function () {
        testAssignmentsModel.resetClassInputCheck();
        vueModel.resetSelectedOptionStudent();
        //LoadTesClassAssignmentToTable(); call when load school finish.
        if ($('#selectDistrict').length > 0)
        {
            LoadTesClassAssignmentToTable(); // default load when Publisher OR NetworkAdmin
        }

        portalV2SkinCheckBox();
    });

    function LoadTesClassAssignmentToTable() {
        var options = {
            bServerSide: true,
            sServerMethod: "POST",
            bDestroy: true,
            bProcessing: false,
            bAutoWidth: false,
            sAjaxSource: '@Url.Action("GetTestClassAssignmentsImproved", "TestAssignmentReview")',
            oLanguage: { "sZeroRecords": "No results meet your search criteria. Try changing your date range or other filters and search again." },
            onSearch: keepSession,
            fnServerParams: function (aoData) {
                var schoolID = 0;
                if ($('#selectSchool').val() != 'select' && $('#selectSchool').val() > 0) {
                    schoolID = $('#selectSchool').val();
                }

                var currentParams = currentFilterParams || _historyData;
                if (!currentParams.districtID && _historyData.districtID) {
                    currentParams.districtID = _historyData.districtID;
                }

                if (!currentParams.assignmentCodes) {
                    currentParams.assignmentCodes = $("#hdAssignmentCodes").val()
                }

                aoData.push(
                    { name: "DateTime", value: currentParams && currentParams.timeFrame ? currentParams.timeFrame : $('#dateTime').val()},
                    { name: "OnlyShowPendingReview", value: showPendingReviewClassTestAssignment },
                    { name: "ShowActiveClassTestAssignment", value: (currentParams && !currentParams.isFormLoad) ? currentParams.showInactive : showActiveClassTestAssignment },
                    { name: "DistrictID", value: currentParams && currentParams.districtID ? currentParams.districtID : -1 },
                    { name: "AssignmentCodes", value: currentParams && currentParams.assignmentCodes ? currentParams.assignmentCodes : '' },
                    { name: "SchoolID", value: currentParams && currentParams.schoolID ? currentParams.schoolID : -1 },
                    { name: "PageLoad", value: currentParams && !currentParams.teacherPageLoad && !_historyData.isFormLoad ? false : teacherReviewerPageLoad },
                     { name: "ModuleCode", value: RestrictionModule.REVIEW_AND_MANUAL_GRADE },
                    { name: "GradeName", value: currentParams && currentParams.grade ? currentParams.grade : '' },
                    { name: "SubjectName", value: currentParams && currentParams.subject ? currentParams.subject : '' },
                    { name: "BankName", value: currentParams && currentParams.bank ? currentParams.bank : '' },
                    { name: "ClassName", value: currentParams && currentParams.class ? currentParams.class : '' },
                    { name: "TeacherName", value: currentParams && currentParams.teacher ? currentParams.teacher : '' },
                    { name: "StudentName", value: currentParams && currentParams.student ? currentParams.student : '' },
                    { name: "TestName", value: currentParams && currentParams.test ? currentParams.test : '' },
                    { name: "Code", value: currentParams && currentParams.testCode ? currentParams.testCode : '' }
                );

                teacherReviewerPageLoad = false;
            },
            iDisplayLength: _historyData.pageSize > 0 ? parseInt(_historyData.pageSize) : 10,
            aoColumns: [
                { sDefaultContent: '', sWidth: '13px', bSearchable: false, bSortable: false },
                { mData: 'QTITestClassAssignmentID', sName: 'QTITestClassAssignmentID', bSearchable: true, bSortable: false, bVisible: true, sWidth: '105px', sClass: 'action-col-style' },
                { mData: 'Assigned', sName: 'Assigned', sType: 'string', bSearchable: true, bSortable: true, bVisible: true, sClass: 'date-col-style', sWidth: '140px'},
                { mData: 'TestName', sName: 'TestName', bSearchable: true, bSortable: true, bVisible: true, sWidth: '300px', sClass: 'test-col-style'},
                { mData: 'TeacherName', sName: 'TeacherName', bSearchable: true, bSortable: true, bVisible: true, sWidth: '130px', sClass: 'teacher-col-style' },
                { mData: 'ClassName', sName: 'ClassName', bSearchable: true, bSortable: true, bVisible: true, sWidth: '130px', sClass: 'class-name-col-style' },
                { mData: 'NotStarted', sName: 'NotStarted', bSearchable: true, bSortable: true, bVisible: true, sWidth: '60px', sClass: 'status-col-style'},
                { mData: 'Started', sName: 'Started', bSearchable: true, bSortable: true, bVisible: true, sWidth: '60px', sClass: 'status-col-style'},
                { mData: 'WaitingForReview', sName: 'WaitingForReview', bSearchable: true, bSortable: true, bVisible: true, sWidth: '60px', sClass: 'status-col-style'},
                { mData: 'Completed', sName: 'Completed', bSearchable: true, bSortable: true, bVisible: true, sWidth: '60px', sClass: 'status-col-style' },
                { mData: 'Code', sName: 'Code', bSearchable: true, bSortable: true, bVisible: true, sWidth: '110px', sClass: 'code-col-style' },
                { mData: 'AuthenticationCode', sName: 'AuthenticationCode', bSearchable: true, bSortable: true, bVisible: true, sWidth: '120px', sClass: 'authentication-code-col-style' },
                { mData: 'StudentNames', sName: 'StudentNames', bSearchable: true, bSortable: false, bVisible: true, sWidth: '120px', sClass: 'student-col-style' },
                { mData: 'ClassID', sName: 'ClassID', bSearchable: true, bSortable: false, bVisible: false },
                { mData: 'SubjectName', sName: 'SubjectName', bSearchable: true, bSortable: false, bVisible: false },
                { mData: 'GradeName', sName: 'GradeName', bSearchable: true, bSortable: false, bVisible: false },
                { mData: 'BankName', sName: 'BankName', bSearchable: true, bSortable: false, bVisible: false },
                { mData: 'VirtualTestID', sName: 'VirtualTestID', bSearchable: true, bSortable: false, bVisible: false },
                { mData: 'CodeTime', sName: 'CodeTime', bSearchable: true, bSortable: false, bVisible: false },
                { mData: 'DistrictID', sName: 'DistrictID', bSearchable: true, bSortable: false, bVisible: false },
                { mData: 'Status', sName: 'Status', bSearchable: true, bSortable: false, bVisible: false },
                { mData: 'AssignmentShortDate', sName: 'AssignmentShortDate', bSearchable: false, bSortable: false, bVisible: false },
                { mData: 'AssignmentShortTime', sName: 'AssignmentShortTime', bSearchable: false, bSortable: false, bVisible: false },
                { mData: 'AssignmentType', sName: 'AssignmentType', bSearchable: false, bSortable: false, bVisible: false },
                { mData: 'BankIsLocked', sName: 'BankIsLocked', bSearchable: false, bSortable: false, bVisible: false },
                { mData: 'IsTeacherLed', sName: 'IsTeacherLed', bSearchable: false, bSortable: false, bVisible: false },
                { mData: 'AssignmentModifiedUserID', sName: 'AssignmentModifiedUserID', bSearchable: false, bSortable: false, bVisible: false },
                { mData: 'AssignmentFirstName', sName: 'AssignmentFirstName', bSearchable: false, bSortable: false, bVisible: false },
                { mData: 'AssignmentLastName', sName: 'AssignmentLastName', bSearchable: false, bSortable: false, bVisible: false },
                { mData: 'IsHide', sName: 'IsHide', bSearchable: false, bSortable: false, bVisible: false },
                { mData: 'SchoolName', sName: 'SchoolName', bSearchable: false, bSortable: false, bVisible: false },
                { mData: 'IsAllowReview', sName: 'IsAllowReview', bSearchable: false, bSortable: false, bVisible: false },
                { mData: 'BankId', sName: 'BankId', bSearchable: false, bSortable: false, bVisible: false },
                { mData: 'IsAuthenticationCodeExpired', sName: 'IsAuthenticationCodeExpired', bSearchable: false, bSortable: false, bVisible: false }
            ],

            aaSorting: [[1, "desc"]],
            oSearch: {
                sSearch: _historyData.searchText
            },
            fnRowCallback: function (nRow, aData) {
                $('td:eq(0)', nRow).parent().addClass('tableRow');
                var assignmentUser = "<span class='tooltipBox' title='" + aData['AssignmentLastName'] + ", " + aData['AssignmentFirstName'] + "' >" + (aData['Assigned']) + "</span>";

                var colContent = {
                    col0: setIconCheckbox(aData['QTITestClassAssignmentID'], aData['Status'], aData['IsHide'], aData['IsTeacherLed']),
                    col1: setIconVisibilityClass(aData['QTITestClassAssignmentID'], aData['Status'], aData['VirtualTestID'], aData['BankIsLocked'], aData, aData['IsVirtualTestRetake'], aData['IsVirtualTestPartialRetake']),
                    col2: assignmentUser,
                    col3: aData['TestName'],
                    col4: aData['TeacherName'],
                    col5: aData['ClassName'],
                    col6: aData['NotStarted'] > 0
                        ? getTooltipStudents(aData['QTITestClassAssignmentID'], aData['NotStarted'], 'NotStarted', aData['Status'])
                        : '0',
                    col7: aData['Started'] > 0
                        ? getTooltipStudents(aData['QTITestClassAssignmentID'], aData['Started'], 'Started', aData['Status'])
                        : '0',
                    col8: aData['WaitingForReview'] > 0
                        ? setReviewText(aData)
                        : setReviewText(aData, true),
                    col9: aData['Completed'] > 0
                        ? getTooltipStudents(aData['QTITestClassAssignmentID'], aData['Completed'], 'Completed', aData['Status'])
                        : '0',
                    col10: portalLinkTestCode(aData['Code'], aData['DistrictID'], aData['IsTeacherLed'], aData['Status']),
                    col11: getAuthenticationCode(aData['QTITestClassAssignmentID'], aData['AuthenticationCode'], aData['IsAuthenticationCodeExpired']),
                    col12:  DisplayStudents(aData['StudentNames'], aData['AssignmentType'], aData['Status'])
                }

                for (var i = 0, totalRow = 13; i < totalRow; i++) {
                    $('td:eq(' + i + ')', nRow).html(colContent['col' + i]);
                }

                return nRow;
            },
            fnPreDrawCallback: function () {
                ShowBlock($('#classDataTable'), 'Loading');
                $('#filterSheets').attr("disabled", "disabled");

                return true;
            },
            fnDrawCallback: function () {
                testAssignmentsModel.resetSelectedTestClassAssignment();
                $('#classDataTable').unblock();
                $('#filterSheets').removeAttr("disabled");

                var _pageSizeDefault = _historyData.pageSize ? _historyData.pageSize : 50;
                var pageSizeGrid = $('#classDataTable_length select').val();
                if (_pageSizeDefault != pageSizeGrid) {
                    keepSession();
                    _pageSizeDefault = pageSizeGrid;
                }

                $('.js-tooltip').parent('td').qtip({
                    content: {
                        text: function (event, api) {
                            var $self = $(this);
                            var $parent = $self.parents('tr');
                            var title = $self.attr('title');
                            var status = $self.find('.js-tooltip').data('status');
                            var assignmentid = $self.find('.js-tooltip').data('assignmentid');
                            var testStatus = $self.find('.js-tooltip').data('teststatus');

                            if (typeof title !== 'undefined' && title !== '') {
                                return title
                            }

                            $.ajax({
                                url: '@Url.Action("GetStudentByCodeAndStatus", "TestAssignmentReview")?qtiTestClassAssignmentId=' + assignmentid,
                                type: 'GET'
                            }).then(function (data) {
                                var currentTooltip = '';
                                var studentsNotStarted = getStudentsByStatus(data.liststudentstatus, 'NotStarted');
                                var studentsStarted = getStudentsByStatus(data.liststudentstatus, 'Started');
                                var studentsWaitingForReview = getStudentsByStatus(data.liststudentstatus, 'WaitingForReview');
                                var studentsCompleted = getStudentsByStatus(data.liststudentstatus, 'Completed');

                                var studentsNotStartedTitle = getStudentsTitle(studentsNotStarted, testStatus);
                                var studentsStartedTitle = getStudentsTitle(studentsStarted, testStatus);
                                var studentsWaitingForReviewTitle = getStudentsTitle(studentsWaitingForReview, testStatus);
                                var studentsCompletedTitle = getStudentsTitle(studentsCompleted, testStatus);

                                var $tdNotStarted = $parent.find('td').eq(6);
                                if (studentsNotStarted.Total) {
                                    var studentsNotStartedTooltip = getStudentsTotal(studentsNotStarted.Total);
                                    $tdNotStarted.attr('title', studentsNotStartedTitle);
                                    $tdNotStarted.html(studentsNotStartedTooltip);
                                } else {
                                    $tdNotStarted.qtip('destroy', true);
                                    $tdNotStarted.html('0');
                                }

                                var $tdStarted = $parent.find('td').eq(7);
                                if (studentsStarted.Total) {
                                    var studentsStartedTooltip = getStudentsTotal(studentsStarted.Total);
                                    $tdStarted.attr('title', studentsStartedTitle);
                                    $tdStarted.html(studentsStartedTooltip);
                                } else {
                                    $tdStarted.qtip('destroy', true);
                                    $tdStarted.html('0');
                                }

                                var $tdWaitingForReview = $parent.find('td').eq(8);
                                if (studentsWaitingForReview.Total) {
                                    var studentsWaitingForReviewTooltip = getStudentsTotal(studentsWaitingForReview.Total, true);
                                    var $pendingReview = $tdWaitingForReview.find('.jsTeacherReview');
                                    var studentsWaitingForReviewButton = createStudentsReviewButton($pendingReview);

                                    $tdWaitingForReview.html('');
                                    $tdWaitingForReview.attr('title', studentsWaitingForReviewTitle);
                                    $tdWaitingForReview.append(studentsWaitingForReviewTooltip);
                                    $tdWaitingForReview.append(studentsWaitingForReviewButton);
                                } else {
                                    $tdWaitingForReview.qtip('destroy', true);
                                    $tdWaitingForReview.html('0');
                                }

                                var $tdCompleted = $parent.find('td').eq(9);
                                if (studentsCompleted.Total) {
                                    var studentsCompletedTooltip = getStudentsTotal(studentsCompleted.Total);
                                    $tdCompleted.attr('title', studentsCompletedTitle);
                                    $tdCompleted.html(studentsCompletedTooltip);
                                } else {
                                    $tdCompleted.qtip('destroy', true);
                                    $tdCompleted.html('0');
                                }

                                if (status === 'NotStarted') {
                                    currentTooltip = studentsNotStartedTitle;
                                } else if (status === 'Started') {
                                    currentTooltip = studentsStartedTitle;
                                } else if (status === 'WaitingForReview') {
                                    currentTooltip = studentsWaitingForReviewTitle;
                                } else if (status === 'Completed') {
                                    currentTooltip = studentsCompletedTitle;
                                }

                                api.set('content.text', currentTooltip);
                            }, function (xhr, status, error) {
                                api.set('content.text', status + ': ' + error);
                            });

                            return 'Loading...';
                        }
                    },
                    hide: {
                        fixed: true,
                        delay: 300
                    },
                    style: {
                        classes: 'qtip-students qtip-bootstrap qtip-shadow'
                    },
                    position: {
                        at: 'center right',
                        my: 'left center',
                        viewport: $('#divClassTestAssignments'),
                        adjust: {
                            method: 'none shift'
                        }
                    }
                });

                getStudentsQtip('.js-tooltip-students');
                $('.header-col-tip').tip();
                $('.with-tip').tip();
                portalV2SkinCheckBox();
                return true;
            },
            fnInitComplete: function () {
                $('.block-footer').append('<span><b>*NS = Not Started, IP = In Progress, PR = Pending Review (or Being Graded), Fini = Completed, Auth = Authenticator, <span class="icon-legend-hide"></span> = Hide Test on Student Portal, <span class="icon-legend-show"></span> = Show Test on Student Portal, <span class="icon-legend-regenerate"></span> = Regenerate Authentication Password</b></span>');
                var elAction = testAssignmentsModel.$el.querySelector('#btnActions');
                var elDeactivate = testAssignmentsModel.$el.querySelector('#formCheckDeactivate');
                var elSearchLabel = $('#classDataTable_filter label');
                var elSearchInput = elSearchLabel.find('input');

                elSearchInput.css({ paddingLeft: '35px', position: 'relative' });
                elSearchInput.get(0).style.setProperty('padding-left', '32px', 'important');
                elAction.style.display = 'inline-block';
                elDeactivate.style.float = 'left';
                elDeactivate.style.marginTop = '10px';
                elDeactivate.style.visibility = elAction.style.visibility = 'visible';

                testAssignmentsModel.$el.querySelector('.block-custom-header').prepend(elDeactivate);
                testAssignmentsModel.$el.querySelector('.data-table-action').prepend(elAction);
                elSearchLabel.replaceWith(elSearchInput);
                $('#classDataTable_filter').addClass('data-search')
                portalV2SkinCheckBox();
                portalV2AddPluginSelect();
                swapFooterTable();
            }
        };

        $("#classDataTable").data("options", options);
    }

    function getStudentsByStatus(students, status) {
        return _.find(students, function (stu) {
            return stu.StudentStatus === status;
        });
    }

    function getStudentsTitle(students, testStatus) {
        var studentNames = students.ListStudents;
        var studentsTitle = '';
        if (studentNames !== '') {
            studentsTitle = getStudentsTitleWithIcon(studentNames, testStatus);
        }
        return studentsTitle;
    }

    function getStudentsTitleWithIcon(studentNames, testStatus) {
        var studentsTitle = '';
        var studentList = studentNames.split('|');

        studentList = studentList.filter(function (stuName) {
            return stuName.trim() !== '';
        }).sort(function (a, b) {
            a = a.toLowerCase().trim().substring(1);
            b = b.toLowerCase().trim().substring(1);
            if (a < b) {
                return -1;
            }
            if (a > b) {
                return 1;
            }
            return 0;
        }).map(function (stuName) {
            var htmlName = "<span class='icon icon-16 icon-student icon-student-offset'></span>" + stuName.substring(2) + '<br/>';
            if (testStatus == 1) {
                var statusStudent = stuName.split('&')[0];
                if (statusStudent == "0") {
                    htmlName = "<span class='icon icon-16 icon-student icon-student-offset'></span><span style='text-decoration: " + (statusStudent == "0" ? 'line-through' : 'auto') + "'>" + stuName.substring(2) + '</span><br/>';
                }                
            }            
            return htmlName;
        });

        studentsTitle = studentList.join('');
        var htmlStartSpan = "<span>"
        var htmlEndSpan = "</span>"
        return htmlStartSpan.concat(studentsTitle).concat(htmlEndSpan);
    }

    function getStudentsTotal(total, isPendingReview) {
        var tooltip = '<span class="js-tooltip">' + total + '</span>';

        if (isPendingReview) {
            tooltip = '<span class="js-tooltip table-assignment-waiting-review">' + total + '</span>';
        }

        return tooltip;
    }

    function getStudentsQtip(el) {
        var $el = $(el);
        $(el).parent('td').qtip({
            content: {
                text: function (event, api) {
                    var $self = $(this);
                    var $parent = $self.parents('tr');
                    var title = $self.attr('title');
                    var status = $parent.children().first().find('input').data('status');
                    var assignmentid = $parent.children().first().find('input').data('qtitestclassassignmentid');

                    $.ajax({
                        url: '@Url.Action("GetAllStudents", "TestAssignmentReview")?qtiTestClassAssignmentId=' + assignmentid,
                        type: 'GET'
                    }).then(function (data) {
                        var currentTooltip = getStudentsTitleWithIcon(data.liststudentstatus, status);
                        api.set('content.text', currentTooltip);
                    }, function (xhr, status, error) {
                        api.set('content.text', status + ': ' + error);
                    });

                    return 'Loading...';
                }
            },
            hide: {
                fixed: true,
                delay: 300
            },
            style: {
                classes: 'qtip-students qtip-bootstrap qtip-shadow'
            },
            position: {
                at: 'center left',
                my: 'right center',
                viewport: $('#divClassTestAssignments'),
                adjust: {
                    method: 'none shift'
                }
            }
        });
    }

    function createStudentsReviewButton(el) {
        var $el = $(el);
        if (!$el.attr('virtualtestid')) return null;
        var btnTeacherReviewContainer = document.createElement('div');
        var btnTeacherReview = document.createElement('a');
        btnTeacherReview.setAttribute('href', 'javascript:void(0);');
        btnTeacherReview.setAttribute('qtitestclassassignmentid', $el.attr('qtitestclassassignmentid'));
        btnTeacherReview.setAttribute('virtualtestid', $el.attr('virtualtestid'));
        btnTeacherReview.setAttribute('classname', $el.attr('classname'));
        btnTeacherReview.setAttribute('districtID', $el.attr('districtID'));
        btnTeacherReview.setAttribute('teachername', $el.attr('teachername'));
        btnTeacherReview.setAttribute('selectfirststudentforreview', $el.attr('selectfirststudentforreview'));
        btnTeacherReview.className = 'big-button btn-review jsTeacherReview';
        btnTeacherReview.textContent = 'Review';
        btnTeacherReviewContainer.style.paddingTop = '5px';
        btnTeacherReviewContainer.appendChild(btnTeacherReview);
        return btnTeacherReviewContainer;
    }
</script>

<script type="text/javascript">


    function SetupFiltersClass() {
        var dataTable = $('#classDataTable').dataTable();
        var settings = dataTable.fnSettings();
        fnResetAllFilters(settings);

        if ($("#selectGrade").val()) {
            FilterColumn($('#selectGrade').val(), 12, settings);
        }

        if ($("#selectBank").val()) {
            FilterColumn($('#selectBank').val(), 13, settings);
        }

        if ($("#selectClass").val()) {
            FilterColumn($('#selectClass').val(), 4, settings);
        }

        if ($("#selectSubject").val()) {
            FilterColumn($('#selectSubject').val(), 11, settings);
        }

        if ($("#selectTeacher").val()) {
            FilterColumn($('#selectTeacher').val(), 3, settings);
        }

        if ($("#selectTest").val()) {
            FilterColumn($('#selectTest').val(), 2, settings);
        }

        if ($("#selectStudent").val()) {
            FilterColumn($('#selectStudent').val(), 20, settings);
        }

        if ($("#selectTestCode").val()) {
            FilterColumn($('#selectTestCode').val(), 9, settings);
        }

        dataTable.fnDraw();
    }

    function setIconVisibilityClass(qtiTestClassAssignmentID, status, virtualTestID, bankIsLockedForTutorial, aData, isVirtualTestRetake, isVirtualTestPartialRetake) {
        if (bankIsLockedForTutorial == null || bankIsLockedForTutorial == '') {
            bankIsLockedForTutorial = '0';
        }
        bankIsLockedForTutorial = parseInt(bankIsLockedForTutorial);
        var splitedString = aData['TestName'].split(' ');
        var retakeName = splitedString[splitedString.length - 1];
        var iconString = "";

        var detailsIcon = '<span class="icon icon-review-pencil"></span>';

        var activateIcon = '<span class="icon fa-solid fa-circle-plus icon-green"></span>';
        var activateString = '<a href="javascript:void(0)" title="Activate" operation="0"'
            + ' classId ="' + aData['ClassID'] + '"' 
            + ' type="' + aData['AssignmentType'] + '"' 
            + ' status="' + aData['Status'] + '"' 
            + ' isHide="' + aData['IsHide'] + '"' 
            + ' studentNames="' + aData['StudentNames'] + '"' 
            + ' qtiTestClassAssignmentID="' + qtiTestClassAssignmentID + '"'
            + ' isRetakeAssignment = "' + isVirtualTestRetake + '"'
            + ' class="with-tip jsChangeStatus btn-review-assignment"'
            + ' testName="' + retakeName + '">' + activateIcon + '</a>';

        var activateDisableIcon = '<span class="icon icon-review-disabled"></span>';
        var activateDisableString = '<a href="javascript:void(0)" title="Bank is locked" operation="0"'
            + ' classId = "' + aData['ClassID'] + '"' 
            + ' type="' + aData['AssignmentType'] + '"' 
            + ' status="' + aData['Status'] + '"' 
            + ' isHide="' + aData['IsHide'] + '"' 
            + ' studentNames="' + aData['StudentNames'] + '"' 
            + ' qtiTestClassAssignmentID = "' + qtiTestClassAssignmentID + '"' 
            + ' class="with-tip btn-review-assignment">' + activateDisableIcon + '</a>';

        var deactivateIcon = '<span class="icon fa-solid fa-circle-minus icon-red"></span>';
        var deactivateString = '<a href="javascript:void(0)" title="Deactivate" operation="1"'
            + ' classId = "' + aData['ClassID'] + '"' 
            + ' type="' + aData['AssignmentType'] + '"' 
            + ' status="' + aData['Status'] + '"' 
            + ' isHide="' + aData['IsHide'] + '"' 
            + ' studentNames="' + aData['StudentNames'] + '"' 
            + ' qtiTestClassAssignmentID="' + qtiTestClassAssignmentID + '"'
            + ' isRetakeAssignment = "' + isVirtualTestRetake + '"'
            + ' class="with-tip jsChangeStatus btn-review-assignment"'
            + ' testName="' + retakeName + '">' + deactivateIcon + '</a>';

        if (bankIsLockedForTutorial > 0) {
            activateString = activateDisableString;
        }

        if (aData.IsAllowReview) {
            detailsString = '<a href="javascript:void(0);" title="Review" class="with-tip jsTeacherReview btn-review-assignment" '
                + ' type="' + aData['AssignmentType'] + '"' 
                + ' status="' + aData['Status'] + '"'
                + ' isHide="' + aData['IsHide'] + '"'
                + ' qtiTestClassAssignmentID="' + qtiTestClassAssignmentID + '"'
                + ' virtualTestID="' + virtualTestID + '"'
                + ' className="' + aData['ClassName'] + '"'
                + ' districtID="' + aData['DistrictID'] + '"'
                + ' teacherName="' + aData['TeacherName'] + '"'
                + ' selectFirstStudentForReview="0"'
                + '>' + detailsIcon + '</a>';

            iconString += detailsString;
        }

        if (status == 1) {
            iconString += deactivateString;
        } else {
            iconString += activateString;
        }

        var href = 'javascript:RegisterOpenDialog(' + virtualTestID + ');';
        var printIcon = '<img src="' + '@Url.Content("~/Content/themes/Constellation/images/icons/fugue/print1.png")' + '" width="16" height="16">';
        var vPrintTestContent = ' <a  class="actionIcon"' +
            'title="Print" href="' + href + '">' + printIcon + '</a> ';

        var preferenceIcon = '<span class="icon icon-review-preference"></span>';
        var preferenceString = '<a href="javascript:void(0)" title="Preferences" operation="0" qtiTestClassAssignmentID="' + qtiTestClassAssignmentID + '" isVirtualTestPartialRetake="' + isVirtualTestPartialRetake + '" class="with-tip jsViewPreference btn-review-assignment">' + preferenceIcon + '</a>';
        iconString += preferenceString;

        if (status == 1 && IsShowUserCurrentDictrictStudentPortal && (aData['IsTeacherLed'] == null || !aData['IsTeacherLed'])) {
            var hideShowIcon = '<span class="icon icon-review-hide"></span>';
            var hideText = 'Hide Test on Student Portal';

            if (aData['IsHide']) {
                hideShowIcon = '<span class="icon icon-review-show"></span>';
                hideText = 'Show Test on Student Portal';
            }

        var hideShowIconString = '<a href="javascript:void(0)" title="' + hideText
            + '" operation="0" qtiTestClassAssignmentID="' + qtiTestClassAssignmentID
            + '" studentNames="' + aData['StudentNames']
            + '" classId="' + aData['ClassID']
            + '" type="' + aData['AssignmentType']
            + '" status="' + aData['Status']
            + '" isHide="' + aData['IsHide']
            + '" class="with-tip jsHideShowAssignment btn-review-assignment" IsTeacherLed='
                + aData['IsTeacherLed'] + '>' + hideShowIcon + '</a>';

        if (IsShowUserCurrentDictrictStudentPortal && (aData['IsTeacherLed'] == null || !aData['IsTeacherLed']))
            iconString += hideShowIconString;
        } else {
            var hiddentIcon = '<span class="icon"></span>';
            var hiddentIcon = '<a href="javascript:void(0)" class="btn-review-assignment"</a>';
            iconString += hiddentIcon;
        }

        return iconString;
    }

    function setIconCheckbox(qtiTestClassAssignmentID, status, isHide, isTeacherLed) {
        var html = '<input type="checkbox" data-qtitestclassassignmentid="' + qtiTestClassAssignmentID + '" data-status="' + status + '"  data-ishide="' + isHide + '"  data-isteacherled="' + isTeacherLed + '" class="rcode" onchange = "rcode_onchange(this,' + qtiTestClassAssignmentID + ',' + status + ',' + isHide + ',' + isTeacherLed + ')" /> ';

        return html;
    }

    function setReviewText(aData, isZero) {
        var waitingForReview = aData['WaitingForReview'];
        var qtiTestClassAssignmentId = aData['QTITestClassAssignmentID'];
        var virtualTestId = aData['VirtualTestID'];
        var iconString = '<span class="js-tooltip js-pending-review" data-assignmentid="' + qtiTestClassAssignmentId + '" data-teststatus="' + aData['Status'] + '" data-status="WaitingForReview"><span class="table-assignment-waiting-review">' + waitingForReview + '</span></span>';

        if (isZero) {
            iconString = '<span class="js-pending-review is-zero" data-assignmentid="' + qtiTestClassAssignmentId + '" data-teststatus="' + aData['Status'] + '"data-status="WaitingForReview"><span class="table-assignment-waiting-review">0</span></span>';
        }

        var reviewButton = '';
        if (aData.IsAllowReview) {
            reviewButton = '<div style="padding-top: 5px;"><a href="javascript:void(0);" class="big-button btn-review jsTeacherReview"'
                + ' qtiTestClassAssignmentID="' + qtiTestClassAssignmentId + '"'
                + ' virtualTestID="' + virtualTestId + '"'
                + ' className="' + aData['ClassName'] + '"'
                + ' districtID="' + aData['DistrictID'] + '"'
                + ' teacherName="' + aData['TeacherName'] + '"'
                + ' selectFirstStudentForReview="1"'
                + ' >Review</a></div>';
        }
        return iconString + reviewButton;
    }

    function getTooltipStudents(assignmentid, data, status, testStatus) {
        return '<span class="js-tooltip" data-assignmentid="' + assignmentid + '" data-status="' + status + '"data-teststatus="' + testStatus + '">' + data + '</span>';
    }

    function DisplayStudents(studentNames, assignmentType, testStatus) {
        var studentElement = '';
        if (studentNames == null) return studentElement;
        if (assignmentType && (assignmentType == 1 || assignmentType == 3)) {
            var studentTitle = getStudentsTitleWithIcon(studentNames, testStatus);
            studentElement = '<span class="js-tooltip-students"><span class="icon icon-24 icon-students"></span></span>';
        } else if (assignmentType && (assignmentType == 2)) {
            studentElement = studentNames;
            studentElement = WrapTextInSpan(studentElement, 15);
        }

        return studentElement;
    }

    function getAuthenticationCode (qtiTestClassAssignmentID, authenticationCode, isAuthenticationCodeExpired) {
        if (authenticationCode) {
            return `
            <span> ${ isAuthenticationCodeExpired ? '' : authenticationCode } 
                <i class="fa-solid fa-arrow-rotate-right regenerate-authenticator-code" 
                    data-qtitestclassassignmentid=${qtiTestClassAssignmentID}
                    data-authenticationcode=${authenticationCode}
                ></i> 
            </span>`;
        }
        return '';
    }

    $('#classDataTable').on('click', '.regenerate-authenticator-code', function (e) {
        var qtiTestClassAssignmentID = e.target.getAttribute('data-qtitestclassassignmentid');
        var authenticationCode = e.target.getAttribute('data-authenticationcode');
        
        ShowBlock($('#classDataTable'), 'Loading');

        $.ajax({
            type: 'POST',
            url: '@Url.Action("GenerateAuthenticationCode", "TestAssignment")',
            data: { qtiTestClassAssignmentID, authenticationCode },
            dataType: 'json',
            traditional: true,
            success: function (response) {
                if (response.Status) {
                    e.target.parentElement.childNodes[0].data = response.AuthenticationCode;
                    e.target.setAttribute('data-authenticationcode', response.AuthenticationCode);
                }
                else {
                    alert('An error has occured. Please refresh the page and try again.');
                }
                $('#classDataTable').unblock();
            },
            error: function () {
                alert('An error has occured. Please refresh the page and try again.');
                $('#classDataTable').unblock();
            }
        });
    });

    $('#classDataTable').on('click', '.jsViewDetail', function (event) {
        event.preventDefault();
        selectedClassAssignmentID = $(this).attr('qtiTestClassAssignmentID');
        var virtualTestID = $(this).attr('virtualTestID');

        PopupTestAssignmentRegrader(selectedClassAssignmentID, null, virtualTestID, 0);
    });

    $('#classDataTable').on('click', '.jsTeacherReview', function (event) {
        // Cache test assignment variables
        var $self = $(this);
        var teacherReviewerQtiTestClassAssignmentID = $self.attr('qtiTestClassAssignmentID');
        var teacherReviewerVirtualTestID = $self.attr('virtualTestID');
        var teacherReviewerSelectFirstStudent = $self.attr('selectFirstStudentForReview');
        var teacherReviewerClassName = $self.attr('className');
        var teacherReviewerTeacherName = $self.attr('teacherName');
        var districtId = $self.attr('districtId');

        var url = '@Url.Action("Index", "TeacherReview")';
        url += '?qtiTestClassAssignmentID=' + teacherReviewerQtiTestClassAssignmentID;
        url += '&virtualTestID=' + teacherReviewerVirtualTestID;
        url += '&selectFirstStudentForReview=' + teacherReviewerSelectFirstStudent;
        url += '&ClassName=' + teacherReviewerClassName;
        url += '&TeacherName=' + teacherReviewerTeacherName;
        url += '&districtId=' + districtId;

        $self.attr('href', encodeURI(url));
    });

    $('#classDataTable').on('click', '.jsReviewPopup', function (event) {
        event.preventDefault();
        var selectedClassAssignmentId = $(this).attr('qtiTestClassAssignmentID');
        var virtualTestId = $(this).attr('virtualTestID');

        PopupTestAssignmentRegrader(selectedClassAssignmentId, null, virtualTestId, 1);
    });

    $('#classDataTable').on('click', '.jsChangeStatus', function (event) {
        event.preventDefault();
        $('.clssOptionStudent').removeClass('input-checked-v2');
        $('.cls-assign-student').prop('disabled', false);
        $('#radioActiveSelected').val('');
        $('#radioDeactiveSelected').val('');
        var qtiTestClassAssignmentID = $(this).attr('qtiTestClassAssignmentID');
        var operationType = $(this).attr("operation");
        var isRetakeAssignment = $(this).attr("isRetakeAssignment") == 'true';
        var testName = $(this).attr("testName");
        var studentNames = $(this).attr('studentNames');
        var classId = $(this).attr('classId');
        var type = $(this).attr('type');
        var status = $(this).attr('status');
        var isHide = $(this).attr('isHide');
        testAssignmentsModel.activeAllStudents = operationType == "0" ? true : false;
        testAssignmentsModel.deActiveAllStudents = operationType == "1" ? true : false;
        var titleHeader = "Are you sure you want to " + (operationType == "1" ? "deactivate" : "activate") + " this assignment?";
        testAssignmentsModel.titleChangeActive = titleHeader;
        testAssignmentsModel.isShowActive = operationType == "1" ? false : true;
        testAssignmentsModel.isShowListStudents = false;
        if (operationType == "1") {
            $('#radioDeactiveAll').prop('checked', true);
            $('#radioDeactiveAll').addClass('input-checked-v2');
        } else {
            $('#radioActiveAll').prop('checked', true);
            $('#radioActiveAll').addClass('input-checked-v2');
        }
        if (studentNames != null && studentNames != '' && studentNames.length > 0) {
            var studentArr = studentNames.split('|');
            testAssignmentsModel.paramChangeActiveAndDeactive.qTITestClassAssignmentID = qtiTestClassAssignmentID;
            testAssignmentsModel.paramChangeActiveAndDeactive.operationType = operationType;
            testAssignmentsModel.paramChangeActiveAndDeactive.testName = testName;
            testAssignmentsModel.paramChangeActiveAndDeactive.isRetakeAssignment = isRetakeAssignment;
            testAssignmentsModel.paramChangeActiveAndDeactive.classId = classId;
            testAssignmentsModel.paramChangeActiveAndDeactive.type = type;
            if (studentArr.length > 1) {
                GetListStudentInClassAssignment(qtiTestClassAssignmentID, classId, type, status, isHide);
                testAssignmentsModel.isShowModalActiveAndDeActive = true;
            }
            else {
                ConfirmClassMessage(titleHeader, qtiTestClassAssignmentID, operationType, testName, isRetakeAssignment, type);
            }
        }
    });

    $('#classDataTable').on('click', '.jsViewPreference', function (event) {
        event.preventDefault();
        ShowBlock($('#classDataTable'), 'Loading');

        var url = '@Url.Action("GetTestAssignmentSetting", "TestAssignment")';
        testSchedule.testClassAssignmentId = $(this).attr('qtiTestClassAssignmentID');
        var isPartialRetake = $(this).attr('isVirtualTestPartialRetake');
        $.ajax({
            url: url,
            data: { testAssingmentId: testSchedule.testClassAssignmentId, isPartialRetake },
            cache: false
        }).done(function (html) {
            $('#classDataTable').unblock();
            $("#dvTestAssignmentDefaultSetting").html(html);
            $('#dvTestAssignmentDefaultSettingPanel').show();
            $('#dvTestAssignmentDefaultSettingPanel').dialog({
                title: "",
                open: function () {
                    //If width of popup gt window width popup auto show on the left
                    var currentPopup = $(this);
                    if (currentPopup.width() > $(window).width()) {
                        currentPopup.parent().css({ "left": "0" });
                    }
                    //Create overlay for popup
                    $("body").append('<div class="my-overlay" style="z-index: ' + ($.ui.dialog.currentZ() - 1) + ';width:' + $(document).width() + 'px;height:' + $(document).height() + 'px;background-color: black;opacity: 0.3;position: absolute;top:0px;left: 0px;"></div>');
                        $('#accordion-preferences-setting').removeClass('w-700')
                },
                beforeclose: function () {
                    return true;
                },
                close: function () {
                    $('#dvTestAssignmentDefaultSettingPanel').hide();
                    $("body .my-overlay").remove();
                    var dataTable = $('#classDataTable').dataTable();
                    dataTable.fnDraw();
                },
                dialogClass: 'testAssignmentDefaultSettingDialog',
                modal: false,
                width: 954,
                resizable: false,
                hideOnClose: true
            });
        });

        $(".close").unbind("click");
        $(".close").live("click", function (e) {
            e.preventDefault();
        });
    });

    $('#classDataTable').on('click', '.jsHideShowAssignment', function (event) {
        $('.cls-show-hide-student').prop('disabled', false);
        vueModel.resetSelectedOptionStudent();
        var $self = $(this);
        event.preventDefault();
        vueModel.isHide = $self.attr('isHide') == 'true' ? true : false;
        vueModel.qtiTestassingmentId = $self.attr('qtiTestClassAssignmentID');

        //Check show list student or show confirm
        var studentNames = $(this).attr('studentNames');
        vueModel.showAllStudents = vueModel.isHide ? true : false;
        vueModel.hideAllStudents = !vueModel.showAllStudents;
        var titleHeader = "Are you sure you want to " + (vueModel.isHide ? "show" : "hide") + " this assignment on Student Portal?";
        vueModel.titleChangeShowHideSPP = titleHeader;
        vueModel.isHideOption = vueModel.isHide ? false : true;
        vueModel.isShowListStudents = false;
        var classId = $self.attr('classId');
        var type = $self.attr('type');
        var status = $(this).attr('status');
        vueModel.AssignmentType = type;
        if (!vueModel.isHide) {
            $('#radioHideAll').prop('checked', true);
            $('#radioHideAll').addClass('input-checked-v2');
        } else {
            $('#radioShowAll').prop('checked', true);
            $('#radioShowAll').addClass('input-checked-v2');
        }
        if (studentNames != null && studentNames != '' && studentNames.length > 0) {
            var studentArr = studentNames.split('|');
            if (studentArr.length > 1) {
                GetListStudentInClassAssignment(vueModel.qtiTestassingmentId, classId, type, status, vueModel.isHide);
                vueModel.isShowModalShowHideSPP = true;
            }
            else {
                vueModel.isShowModalHideShow = true;
            }
        }
    });

    function ConfirmClassMessage(message, qtiTestClassAssignmentID, operationType, testName, isRetakeAssignment, type) {
        var hbody = $("body").height() - 109;
        testName = "'" + testName + "'";
        var configData = {
            message,
            cbYesBtnFuncName: 'HandleClassOKClick(' + qtiTestClassAssignmentID + ', ' + operationType + ', ' + testName + ', ' + isRetakeAssignment + ', ' + type + ')',
            cbCancelBtnFuncName: 'HandleClassCancelClick()',
            cbCloseBtnFuncName: 'HandleClassCancelClick();'
        }
        var strHtml = makeYesNoDialog(configData)
        $("<div></div>")
            .html(strHtml)
            .addClass("dialog dialog-custom-new-skin")
            .attr("id", "messageClassDialog")
            .appendTo("body")
            .dialog({
                open: function () {
                    $(this).parents('.ui-dialog').find('.ui-dialog-titlebar-close').remove()
                },
                close: function () { $(this).remove(); },
                modal: true,
                width: 500,
                maxheight: 400,
                resizable: false
            });

        $(".ui-dialog").css("height", hbody);
        //$(window).scrollTop(0);
    }

    function HandleClassOKClick(qtiTestClassAssignmentID, operationType, testName, isRetakeAssignment, type) {
        var students = [];
        if (testAssignmentsModel.deActiveAllStudents == true || testAssignmentsModel.activeAllStudents == true) {
            testAssignmentsModel.studentList.forEach(function (student) {
                students.push(parseFloat(student.StudentId));
            });
        }
        else {
            $(".student-item[isSelected=yes]").each(function () {
                students.push(parseFloat($(this).attr('studentId')));
            });
        }        
        if (testAssignmentsModel.activeSelectedStudents == true || testAssignmentsModel.deActiveSelectedStudents == true) {
            if (students.length === 0) {
                $('.cls-assign-student').prop('disabled', true);
            }
            else {
                $('.cls-assign-student').prop('disabled', false);
            }
        };
        $("#messageClassDialog").dialog("close");
        if (isRetakeAssignment && operationType != 1) {
            ShowBlock($('#divClassTestAssignments'), 'Loading student');
            $.post('@Url.Action("CanActive")', { qtiTestClassAssignmentID: qtiTestClassAssignmentID, operation: operationType, studentStr: students.join(','), type: type }, function (response) {
                if (response == false) {
                    var message = 'This student has an existing ' + testName + ' assignment or has already completed the test'
                    AlertMessageCustom(message)
                } else {
                    SetupFilters();
                    testAssignmentsModel.isShowModalActiveAndDeActive = false;
                }
            });
        } else {
            $.post('@Url.Action("ChangeStatus")', { qtiTestClassAssignmentID: qtiTestClassAssignmentID, operation: operationType, studentStr: students.join(','), type: type }, function (response) {
                SetupFilters();
                testAssignmentsModel.isShowModalActiveAndDeActive = false;
            });
        }
        $('.clssOptionStudent').prop("checked", false);
        $('.clssOptionStudent').val("");
    }

    function AlertMessageCustom(message) {
        var oldzIndex = $('#idPopUpOnlineTearcherPreview').parent('.ui-dialog').css('z-index');
        $('#alert-message-custom').parent('.ui-dialog').css({ 'z-index': '10000' });
        var configData = {
            message,
            cbYesBtnFuncName: 'CloseAlertMessageCustom()'
        }
        var strHtml = makeAnnounceDialog(configData)
        $("<div></div>")
            .html(strHtml)
            .addClass("dialog dialog-custom-new-skin")
            .attr("id", "alert-message-custom")
            .appendTo("body")
            .dialog({
                open: function () {
                    $(this).parents('.ui-dialog').find('.ui-dialog-titlebar-close').remove()
                },
                close: function () {
                    $('.ui-widget-overlay:last').remove();
                    $('#idPopUpOnlineTearcherPreview').parent('.ui-dialog').css({ 'z-index': oldzIndex });//recover the old value
                    $(this).remove();
                },
                modal: false,
                width: 460,
                maxheight: 500,
                resizable: false,
            });
        showModalDialogBG();
    }

    function showModalDialogBG() {
        var win = $('body');
        $('body').prepend('<div class="ui-widget-overlay" style="width: ' + win.width() + 'px; height: ' + win.height() + 'px; z-index: 1001;"></div>');
    }

    function CloseAlertMessageCustom() {
        $("#alert-message-custom").dialog("close");
    }

    function HandleClassCancelClick() {
        $("#messageClassDialog").dialog("close");
    }

    function TextAbstract(text, length) {
        if (text == null) {
            return "";
        }
        if (text.length <= length) {
            return text;
        }
        text = text.substring(0, length);
        var last = text.lastIndexOf(" ");
        if (last > 0) text = text.substring(0, last);

        text = $.trim(text);
        if (text.indexOf(",") == text.length - 1) text = text.substring(0, text.length - 1);

        return text + "...";
    }

    function WrapTextInSpan(text, length) {
        var shortText = TextAbstract(text, length);
        var result = '<span title="' + text + '">' + shortText + '</span>';
        return result;
    }

    function portalLinkTestCode(code, districtId, isTeacherLed, status) {
        if (isTeacherLed == true && status == 1) {
            var extractedCode = code;
            var isTutorial = code.search(" Tutorial") != -1;
            if (isTutorial) {
                extractedCode = code.substring(0, code.search("Tutorial"));
            }

            var testTakerUrl = $('#hdfUrlTestTaker').val();
            var result = '<a target="_blank" href="' + testTakerUrl + extractedCode + '">' + extractedCode + '</a > ';
            if (isTutorial)
                result = result + "<br> Tutorial";
            return result;
        }
        return code;
    }

    function openUrl(url) {
        window.location.href = url;
    }

    function ExportTestAssignments() {
        var schoolID = 0;
        if ($('#selectSchool').val() != 'select' && $('#selectSchool').val() > 0) {
            schoolID = $('#selectSchool').val();
        }

        var utcOffset = new Date().getTimezoneOffset() != undefined ? new Date().getTimezoneOffset() / 60 : '';
        var url = '@Url.Action("ExportTestAssignments")';
        ShowBlock($('#divClassTestAssignments'), "Exporting");
        $.ajax({
            url: url,
            data: {
                DateTime: $('#dateTime option:selected').val(),
                OnlyShowPendingReview: showPendingReviewClassTestAssignment,
                ShowActiveClassTestAssignment: showActiveClassTestAssignment,
                DistrictID: $('#selectDistrict').val(),
                AssignmentCodes: $('#hdAssignmentCodes').val(),
                Grade: $('#selectGrade').val(),
                Subject: $('#selectSubject').val(),
                Bank: $('#selectBank').val(),
                Class: $('#selectClass').val(),
                Teacher: $('#selectTeacher').val(),
                TestName: $('#selectTest').val(),
                Student: $('#selectStudent').val(),
                Code: $('#selectTestCode').val(),
                SearchBox: $('#classDataTable_filter input').val(),
                SchoolID: schoolID,
                UtcOffsetClient: utcOffset
            },
            cache: false
        }).done(function (url) {
            $('#divClassTestAssignments').unblock();
            popupAlertExportInfoMessage('ui-popup-exportInfo', 350, 125, url);
        });
    }

    function ExportStudentSessions() {
        var schoolID = 0;
        if ($('#selectSchool').val() != 'select' && $('#selectSchool').val() > 0) {
            schoolID = $('#selectSchool').val();
        }

        var url = '@Url.Action("ExportTestStudentSessions")';
        ShowBlock($('#divClassTestAssignments'), "Exporting");
        $.ajax({
            url: url,
            data: {
                DateTime: $('#dateTime option:selected').val(),
                OnlyShowPendingReview: showPendingReviewClassTestAssignment,
                ShowActiveClassTestAssignment: showActiveClassTestAssignment,
                DistrictID: $('#selectDistrict').val(),
                AssignmentCodes: $('#hdAssignmentCodes').val(),
                Grade: $('#selectGrade').val(),
                Subject: $('#selectSubject').val(),
                Bank: $('#selectBank').val(),
                Class: $('#selectClass').val(),
                Teacher: $('#selectTeacher').val(),
                TestName: $('#selectTest').val(),
                Student: $('#selectStudent').val(),
                Code: $('#selectTestCode').val(),
                SearchBox: $('#classDataTable_filter input').val(),
                SchoolID: schoolID
            },
            cache: false
        }).done(function (url) {
            $('#divClassTestAssignments').unblock();
            popupAlertExportInfoMessage('ui-popup-exportInfo', 350, 125, url);
        });
    }

    function popupAlertExportInfoMessage(contentClass, w, h, url) {
        var contentHtml = '';
        var $div = $('<div />');

        w = w !== undefined ? w : 400;
        h = h !== undefined ? h : 100;

        contentHtml += '<div class="popup-exportInfo">';
        contentHtml += '<div class="u-m-t-15 u-m-b-15 u-text-center">';
        contentHtml += '<p>Your export is ready. <br/ > Click OK to download.</p>';
        contentHtml += '</div>';
        contentHtml += '<div class="u-text-center">';
        contentHtml += '<a target="_blank" onclick="CloseExportPopup()" href="' + url + '" class="big-button">OK</a>';
        contentHtml += '</div>';
        contentHtml += '</div>';

        $div.html(contentHtml)
            .attr('id', 'popup-exportInfo')
            .appendTo('body')
            .dialog({
                modal: true,
                width: w,
                minHeight: h,
                resizable: false,
                dialogClass: contentClass,
                close: function () {
                    $(document).find('#popup-exportInfo').dialog('destroy').remove();
                }
            });
    };

    function CloseExportPopup() {
        $(document).find('#popup-exportInfo').dialog('destroy').remove();
    }

    function GetListStudentInClassAssignment(qtiTestClassAssignmentId, classId, type, status, isHide) {
        $.ajax({
            method: 'GET',
            url: '@Url.Action("LoadStudentStatusInClass", "TestAssignmentReview")',
            data: {
                qtiTestClassAssignmentId: qtiTestClassAssignmentId,
                classId: classId,
                type: type,
                status: status,
                isHide: isHide
            },
            beforeSend: function () {
                ShowBlock($('#fsStudentSelect'), 'Loading student');
            },
            success: function (students) {                
                testAssignmentsModel.studentList = students;
                testAssignmentsModel.studentListFilter = students;
                //Group show hide
                vueModel.studentList = students;
                vueModel.studentListFilterShowHide = students;
            },
            error: function () {
                $('#fsStudentSelect').unblock();
            }
        });
    }

    $('.group-active-deactive .generate-student-list li').live({
        mouseenter: function () {
            if ($(this).attr('isselected') == "yes") {
                $(this).css('background-color', "#75B6E1");
            }
            else {
                $(this).css('background-color', "#e0e0e0");
            }
        },
        mouseleave: function () {
            if ($(this).attr('isselected') == "yes") {
                $(this).css('background-color', "#82CAFA");
            }
            else {
                $(this).css('background-color', "#f2f2f2");
            }
        },
        click: function () {
            //TODO: Click Student Item
            if ($('#chkUseRoster').is(":checked")) {
                return;
            }
            if ($(this).attr('isselected') == "yes") {
                $(this).attr('isSelected', "no");
                $(this).css('background-color', "#e0e0e0");
            }
            else {
                $(this).attr('isSelected', "yes");
                $(this).css('background-color', "#75B6E1");
            }
            //TODO: check Valid Assignment
            checkButtomSaveAssginment();
        }
    });

    function checkButtomSaveAssginment() {
        var lengthCheck = $(".student-item[isSelected=yes]").length;
        if (lengthCheck > 0) {
            $('.cls-assign-student').prop('disabled', false);
        }
        else {
            $('.cls-assign-student').prop('disabled', true);
        }
    }

    //Group show hide spp
    $('.group-show-hide .generate-student-list li').live({
        mouseenter: function () {
            if ($(this).attr('isselected') == "yes") {
                $(this).css('background-color', "#75B6E1");
            }
            else {
                $(this).css('background-color', "#e0e0e0");
            }
        },
        mouseleave: function () {
            if ($(this).attr('isselected') == "yes") {
                $(this).css('background-color', "#82CAFA");
            }
            else {
                $(this).css('background-color', "#f2f2f2");
            }
        },
        click: function () {
            //TODO: Click Student Item
            if ($('#chkUseRoster').is(":checked")) {
                return;
            }
            if ($(this).attr('isselected') == "yes") {
                $(this).attr('isSelected', "no");
                $(this).css('background-color', "#e0e0e0");
            }
            else {
                $(this).attr('isSelected', "yes");
                $(this).css('background-color', "#75B6E1");
            }
            //TODO: check Valid Assignment
            checkButtomSaveShowHideAssginment();
        }
    });

    function checkButtomSaveShowHideAssginment() {
        var lengthCheck = $(".student-item-show-hide[isSelected=yes]").length;
        if (lengthCheck > 0) {
            $('.cls-show-hide-student').prop('disabled', false);
        }
        else {
            $('.cls-show-hide-student').prop('disabled', true);
        }
    }
</script>

<script>
    var testPreferenceModel = null;

    function BuildDistrictSettings() {

    }

    var vDurationType = $('#hdfDurationType').val();
    var sDurationType = vDurationType == '2' ? 'Time Spent' : 'Time Remaining';
    function BuildFormatDeadline() {
        try {
            var tmp = new Date($('#hdfDdeadlineId').val());
            var vMonth = parseInt(tmp.getMonth()) + 1;
            var vMinutes = parseInt(tmp.getMinutes());
            var strMinutes = vMinutes.toString();
            if (vMinutes < 10) {
                strMinutes = '0' + strMinutes;
            }
            var strAPM = 'AM';
            var vHouse = tmp.getHours();
            if (vHouse > 12) {
                vHouse = vHouse - 12;
                strAPM = 'PM';
            }
            var vString = tmp.toLocaleDateString() + ' ' + vHouse + ':' + strMinutes + ' ' + strAPM;
            return vString;
        } catch (e) {
            CustomAlert(e);
        }
    }

    function DisplayRate(rate) {
        if (rate === '0.8')
            return 'Normal';
        if (rate === '0.7')
            return 'Slow';
        return '';
    }

    function DisplayVolume(volume) {
        return volume * 10;
    }
</script>
